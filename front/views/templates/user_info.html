<form id="formContainer" method="post" action="#">
 <?py if err: ?>
 <div>
    ${err}
 </div>
 <?py #endif ?>

</form>

<script type="text/javascript">
var profile = #{user_profile};

function getTemplate(name, item)
{
    var result = { template: '', callbacks: [] };

    switch (item.type) {

    case 'text': {
        var tpl = '';

        tpl += '<p>' +
                   '<label for="' + name + '">' + item.name + '</label>' +
                   '<input type="text" id="' + name + '" ' +
                   'name="' + name + '" value="' + item.value +'" />' +
               '</p>';

        if (typeof item.accept !== 'undefined' && item.accept) {
            $("#" + name).live('blur', function() {
                var reg = new RegExp(item.accept);
                if (! reg.test(this.value)) {
                    /* XXX allow customisation of the
                       input error handling */
                    alert('Bad value: ' + this.value);
                }
            });
        }

        result.template = tpl;
    } break;

    case 'select': {
        var tpl = '';

        if (typeof item.accept !== 'undefined' && item.accept) {
            tpl +=
            '<p>' +
                '<label for="' + name + '">' + item.name + '</label>' +
                '<select id="' + name + '" name="' + name + '">';
            for (k in item.accept) {
                tpl +=
                '<option value="' + item.accept[k] + '"';
                if (item.value == item.accept[k])
                    tpl += ' selected="selected"';
                tpl += '>' + k + '</option>';
            }
            tpl +=
                '</select>' +
            '</p>';
        }

        result.template = tpl;
    } break;

    case 'radio': {
        var tpl = '';

        if (typeof item.accept !== 'undefined' && item.accept) {
            for (k in item.accept) {
                tpl += '<label for="' + name + '">' + k + '</label>' +
                       '<input type="radio" id="' + name + '" ' +
                       'name="' + name + '" value="' + item.value + '" ';
                if (item.value == item.accept[k])
                    tpl += ' checked="checked"';
                tpl += '/>';
            }
        }

        result.template = tpl;
    } break;

    case 'fieldset': {
        var tpl = '';

        for (i in item.values) {
            tpl += '<fieldset>';

            if (typeof item.name !== 'undefined')
                tpl += '<legend>' + item.name + '</legend>';

            for (j in item.fields) {
                /* correct id for the dependency */
                if (typeof item.fields[j].depends !== 'undefined') {
                    if (item.fields[j].depends != '')
                        item.fields[j].depends += '_' + item.values[i].id;
                }
                /* add the matching value */
                item.fields[j].value = item.values[i][j];
                var ret = getTemplate(j + '_' + item.values[i].id, item.fields[j]);
                tpl += ret.template;
                result.callbacks = result.callbacks.concat(ret.callbacks);
            }

            tpl += '</fieldset>';
        }

        result.template = tpl;
    } break;

    case 'ajax': {
        console.log(name);
        if (typeof item.depends !== 'undefined' && item.depends) {
            console.log(name + " " + item.depends + " " + item.source);
            /* setup a onchange hook */
            result.callbacks.push(function() {
                $('#' + item.depends).live('change', function() {
                    $.ajax({ 'url': item.source,
                             'data': { "dep": this.value,
                                       "val": item.value },
                             'type': 'GET',
                             'async': false, /* avoid race condition */
                             'dataType': 'json',
                             'success': function(d) {
                                 if (d.type != 'ajax') {
                                     var t = getTemplate(name, d).template;
                                     $("#wrapper_" + name).html(t);
                                 }
                             },
                           });
                });
                $('#' + item.depends).change();
            });
            result.template = '<p id="wrapper_' + name + '"></p>';
        } else {
            console.log(name + " " + item.source);
            result.callbacks.push(function() {
                $.ajax({ 'url': item.source,
                         'data': { "val": item.value },
                         'type': 'GET',
                         'async': false, /* avoid race condition */
                         'dataType': 'json',
                         'success': function(d) {
                             if (d.type != 'ajax') {
                                 var t = getTemplate(name, d).template;
                                 $("#ajax_" + name).html(t);
                             }
                         },
                       });
            });
            result.template = '<p id="ajax_' + name + '"></p>';
        }
    } break;

    }

    return result;
}

$(document).ready(function() {
    var elem;
    for (name in profile) {
        elem = getTemplate(name, profile[name]);
        $("#formContainer").append(elem.template);
        for (c in elem.callbacks) elem.callbacks[c]();
    }
});
</script>

