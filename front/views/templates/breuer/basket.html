<div>
    <ul>
        <li class="li1 on"><a href="#">Mon Panier</a></li>
        <li class="li2">Identification</li>
        <li class="li3">Adresse</li>
        <li class="li4">Livraison</li>
        <li class="li5">Paiement</li>
    </ul>
    <table cellpadding="0" cellspacing="0" border="0">
        <thead>
            <tr>
                <th class="left">Produit</th>
                <th class="left">Description</th>
                <th>Prix unitaire</th>
                <th>Quantité</th>
                <th></th> 
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            <?py for item in basket: ?>
            <tr data="${item['item']}">
                <td class="left"><img width="80px" src="${item['variant'].get('img') or get_single_attribute(item['product'], 'img')}"/></td>
                <td class="left">
                    <h1>${item['product']['name']}</h1>
                    <strong>
                    <?py if item['variant']: ?><span>${item['variant']['name']}</span><?py #endif ?>
                    <?py if item['type']: ?><span>${item['type']['name']}</span><?py #endif ?>
                    </strong>
                </td>
                <td><span id="price">${item['product']['price'] or item['type'].get('price', {}).get('#text')}</span><span id="currency">${item['product']['currency']}</span></td>
                <td><input id="quantity" name="nb_product" type="text" value="${item['quantity']}" /></td>
                <td><a href="javascript:void(0)" id="supprimer" title="Supprimer">x</a></td>
                <td><span id="amount"></span><span>${item['product']['currency']}</span></td>
            </tr>
            <?py #endfor ?>
            <tr>
                <td colspan="2" class="left"><label for="code">Code Avantage :</label> <input id="code" name="code" type="text" value="" /><input id="btnOk" type="submit" value="Ok" /></td>
                <td colspan="4" class="right">
                    <span>Total produits TTC: </span>
                    <span id="sum_amount"></span>
                    <span id="sum_amount_currency"></span>
                </td>
            </tr>
        </tbody>
    </table>
    <a class="btn purchase" href="javascript:next()">Valider</a>
    <a class="btn back" href="javascript:history.go(-1)">Continuer mes achats</a>
</div>

<div class="listProd listFiche">
<strong class="discover"><span>&Agrave; découvrir également</span></strong>
<?py for p in product_list[:5]: ?>
    <?py include('_product_list_item.html', p=p) ?>
<?py #endfor ?>
</div>

<script type="text/javascript">
function next() {
    if ($('tr #amount').length == 0) return;
    location = "${order_addr_url_format}";
}
function calc_row(tr) {
    tr.find("#amount").text(tr.find("#price").text() * tr.find("#quantity").val());
}
function calc_sum() {
    var currency = "";
    var diff_currency = false;
    $('tr #currency').each(function(){
        if (currency == "") {
            currency = $(this).text();
        } else if (currency != $(this).text()) {
            // different currencies ??
            diff_currency = true;
        }
    });
    if (diff_currency) {
        $('#sum_amount').hide().siblings().hide();
        return;
    }

    var sum = 0;
    $('tr #amount').each(function(){
        sum += $(this).text() * 1;
    });
    $('#sum_amount').text(sum);
    $('#sum_amount_currency').text(currency);
    $('#sum_amount').show().siblings().show();
}

$(function() {
    $('tr #amount').each(function(){
        calc_row($(this).parent().parent());
    });
    calc_sum();

    $('tr #quantity').change(function(){
        // update quantity
        var tr = $(this).parent().parent();
        calc_row(tr);
        calc_sum();

        $.post('/basket', {
            'cmd': 'update',
            'sale': tr.attr('data'),
            'quantity': $(this).val(),
        });
    });
    $('tr #supprimer').click(function(){
        // remove item
        var tr = $(this).parent().parent();
        tr.remove();
        calc_sum();

        $.post('/basket', {
            'cmd': 'del',
            'sale': tr.attr('data'),
        });
    });
});
</script>
