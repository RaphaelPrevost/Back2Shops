{% extends base_template %}
{% load i18n %}
{% load thumbnail %}
{% load static %}
{% load get_ta_name %}
{% load get_cur_name %}
{% load calc_premium_price %}

{#Form to add product#}

{% block form %}
    {{ wizard.management_form }}
    <fieldset>
        <div class="p_vide formrow">
            {{ wizard.form.non_field_errors }}
        </div>
        {{ wizard.form.category.errors }}
        <div class="formrow">
            <label for="{{ wizard.form.category.auto_id }}">{% trans wizard.form.category.label %}</label>
            {{ wizard.form.category }}
        </div>
        {{ wizard.form.type.errors }}
        <div class="marge formrow">
            <label for="{{ wizard.form.type.auto_id }}">{% trans wizard.form.type.label %}</label>
            {{ wizard.form.type }}
            <select id="product_type_selector" name="product_type_selector" onchange="getItemTypeAttributeOptions(this.value)"></select>
        </div>
        <div class="marge formrow">
            {{ wizard.form.pictures.management_form }}
            <label for="visuel">{% trans "Product pictures" %}</label>
            <div id="product_pictures" class="visuelProd">
                <label id="pp_upload_btn" role="button">
                    <input id="pp_upload" type="file" name="files[]" multiple>
                </label>
                <ul id="pp_queue"></ul>
                <p id="existing_pp" />
            </div>
        </div>
        {{ wizard.form.brand.errors }}
        <div class="formrow">
            <label for="{{ wizard.form.brand.auto_id }}">{% trans "Brand name" %}</label>
            {{ wizard.form.brand }} {% trans "or" %}  <a href="#" id="add_new_brand">{% trans "Add a new brand" %}</a>
            <span id="brand_new_error" style="display:none"></span>
        </div>
        {{ wizard.form.name.errors }}
        <div class="formrow">
            <label for="{{ wizard.form.name.auto_id }}">{% trans wizard.form.name.label %}</label>
            {{ wizard.form.name }}
        </div>
        {{ wizard.form.description.errors }}
        <div class="marge formrow">
            <label for="{{ wizard.form.description.auto_id }}">{% trans wizard.form.description.label %}</label>
            {{ wizard.form.description }}
        </div>

        {{ wizard.form.weight_unit.errors }}
        <div class="formrow">
            <label for="{{ wizard.form.weight_unit.auto_id }}">{% trans wizard.form.weight_unit.label %}</label>
            <span>{{wizard.form.weight_unit }}</span>
        </div>

        {{ wizard.form.standard_weight.errors }}
        <div class="marge formrow">
            {{ wizard.form.type_attribute_weights.management_form }}
            <label>{% trans "Weight" %}</label>
            <span class="contForm" id="type_attribute_weights">
                <div id="add_taw_form">
                    <select id="type_attribute_weight_selector" name="type_attribute_weight_selector">
                        <option value="0">{% trans "Standard Weight" %}</option>
                    </select>
                    <span class="raw">></span>
                    <input id="type_attribute_weight_input" class="inputXS" type="text" name="type_attribute_weight_input"/>
                    <span id="taw_weight_unit">{{ wizard.form.weight_unit.value }}</span>
                    <a id="add_taw" href="#">{% trans "Add" %}</a>
                </div>

                {{ wizard.form.standard_weight }}
                {% if wizard.form.standard_weight.value %}
                    <span class="standard_weight_form">
                    <span class="standard_weight_name">{% trans "Standard Weight" %}</span>
                    <span class="standard_weight">{{ wizard.form.standard_weight.value }}</span>
                    <span class="standard_weight_unit">{{ wizard.form.weight_unit.value }}</span>
                    <span class="remove_standard_weight">{% trans "Remove" %}</span>
                </span>
                {% endif %}
                {% for f in wizard.form.type_attribute_weights %}
                    <span id="{{ f.prefix }}-row" class="type_attribute_weight_form" {% if f.DELETE.value %}style="display: none;"{% endif %}>
                    {{ f.taw_id }}
                    {{ f.type_attribute }}
                    {{ f.type_attribute_weight }}
                    <input style="display: none;" type="checkbox" name="{{ f.DELETE.html_name }}" id="{{ f.DELETE.auto_id }}" {% if f.DELETE.value %}checked="checked"{% endif %}>
                    <span id="{{ f.prefix }}-type_attribute" class="type_attribute_value">{{ f.type_attribute.value }}</span>
                    <span id="{{ f.prefix }}-type_attribute_name" class="type_attribute_name">{% get_ta_name f.type_attribute.value %}</span>
                    <span id="{{ f.prefix }}-type_attribute_weight" class="type_attribute_weight">{{ f.type_attribute_weight.value }}</span>
                    <span id="{{ f.prefix }}-type_attribute_weight_unit" class="type_attribute_weight_unit">{{ wizard.form.weight_unit.value }}</span>
                    <span class="remove_type_attribute_weight">{% trans "Remove" %}</span>
                </span>
                {% endfor %}
            </span>
        </div>

        {{ wizard.form.currency.errors }}
        <div class="formrow">
            <label for="{{ wizard.form.currency.auto_id }}">{% trans wizard.form.currency.label %}</label>
            <span>{{wizard.form.currency}}</span>
            <input type="hidden" name="{{wizard.form.currency.html_name}}" value="{{wizard.form.currency.value}}" />
        </div>

        {{ wizard.form.normal_price.errors }}
        <div class="marge formrow">
            {{ wizard.form.type_attribute_prices.management_form }}
            <label>{% trans "Price" %}</label>
            <span class="contForm" id="type_attribute_prices">
                <div id="add_tap_form">
                    <select id="type_attribute_selector" name="type_attribute_selector">
                        <option value="0">{% trans "Unified price" %}</option>
                    </select>
                    <span class="raw">></span>
                    <input id="type_attribute_price_input" class="inputXS" type="text" name="type_attribute_price_input"/>
                    <span id="tap_currency">EUR</span>
                    <a id="add_tap" href="#">{% trans "Add" %}</a>
                </div>

            {{ wizard.form.preview_base_price }}

            {{ wizard.form.normal_price }}
            {% if wizard.form.normal_price.value %}
                <span class="normal_price_form">
                    <span class="normal_price_name">{% trans "Price" %}</span>
                    <span class="normal_price_price">{{ wizard.form.normal_price.value }}</span>
                    <span class="normal_price_currency">{% get_cur_name wizard.form.currency.value %}</span>
                    <span class="remove_normal_price">{% trans "Remove" %}</span>
                </span>
            {% endif %}
            {% for f in wizard.form.type_attribute_prices %}
                <span id="{{ f.prefix }}-row" class="type_attribute_price_form" {% if f.DELETE.value %}style="display: none;"{% endif %}>
                    {{ f.tap_id }}
                    {{ f.type_attribute }}
                    {{ f.type_attribute_price }}
                    <input style="display: none;" type="checkbox" name="{{ f.DELETE.html_name }}" id="{{ f.DELETE.auto_id }}" {% if f.DELETE.value %}checked="checked"{% endif %}>
                    <span id="{{ f.prefix }}-type_attribute" class="type_attribute_value">{{ f.type_attribute.value }}</span>
                    <span id="{{ f.prefix }}-type_attribute_name" class="type_attribute_name">{% get_ta_name f.type_attribute.value %}</span>
                    <span id="{{ f.prefix }}-type_attribute_price" class="type_attribute_price">{{ f.type_attribute_price.value }}</span>
                    <span id="{{ f.prefix }}-type_attribute_price_cur" class="type_attribute_price_currency">{% get_cur_name wizard.form.currency.value %}</span>
                    <span class="remove_type_attribute_price">{% trans "Remove" %}</span>
                </span>
            {% endfor %}
            </span>
        </div>

        {{ wizard.form.discount.errors }}
        {{ wizard.form.discount_type.errors }}
        <div class="marge formrow">
            <label for="prixBTS">{% trans "BackToShops Price" %}</label>
            <span class="contForm" id="newPrice">
                {{ wizard.form.discount_type }}
                {{ wizard.form.preview_discount_price_str }}
                <span class="raw">></span>{{ wizard.form.discount }}<span id="discount_marker" class="discount_marker">%</span>
                <span id="result">{% trans "Discounted price" %} : <strong id="discount_price">{% trans "N/A" %}</strong> <strong id="id_discount_price_marker">&nbsp;</strong></span>
            </span>
        </div>
        {{ wizard.form.valid_from.errors }}
        {{ wizard.form.valid_to.errors }}
        <div class="marge formrow">
            <label>{% trans "Valid through" %}</label>
            <span>{{ wizard.form.valid_from.label }}</span>{{ wizard.form.valid_from }}
            <span>{{ wizard.form.valid_to.label }}</span>{{ wizard.form.valid_to }}
        </div>
        <ul id="ba_error" style="display:none;" class="errorlist"></ul>
        <div class="marge formrow">
            <label>{% trans "Brand attributes" %}</label>
            {{ wizard.form.brand_attributes.management_form }}
            <span class="contForm" id="brand_attributes">
                <div id="add_ba_form">
                    <div id="ba">
                        <input id="ba_input" type="text" maxlength="50"/>

                        <img id="ba_texture_btn" role="button">
                        <input id="ba_texture_upload" type="file" name="texture_file"/>
                    </div>
                    <img id="ba_preview_btn" role="button" />
                    <input id="ba_preview_upload" type="file" name="files[]"/>
                    <a id="add_ba" href="#">{% trans "Add" %}</a>

                    <span id="newPriceAttrib" class="contForm">
                        <select id="premium_type" name="premium_type">
                            <option value="percentage">{% trans "Percentage" %}</option>
                            <option value="amount">{% trans "Amount" %}</option>
                        </select>
                        <span class="raw">></span>
                        <input id="premium_amount" class="inputXS" type="text" />
                        <span id="premium_marker" class="premium_marker">%</span>
                        <input style="display:none;" id="premium_price_val" type="hidden" />
                        <span id="premium_result">Premium price : <strong id="premium_price">{% trans "N/A" %}</strong> <strong id="id_premium_price_marker">&nbsp;</strong></span>
                    </span>
                </div>
                {% for f in wizard.form.brand_attributes %}
                <span id="{{ f.prefix }}-row" class="brand_attribute_form brand_attribute_form_{{ f.ba_id.value }}" {% if f.DELETE.value == "on" %}style="display: none;"{% endif %}>
                    {{ f.name }}
                    {{ f.ba_id }}
                    {{ f.texture }}
                    {{ f.preview }}
                    {{ f.preview_pk }}
                    {{ f.premium_type }}
                    {{ f.premium_amount }}
                    <input style="display: none;" type="checkbox" name="{{ f.DELETE.html_name }}" id="{{ f.DELETE.auto_id }}" {% if f.DELETE.value == "on" %}checked="checked"{% endif %}>
                    <span id="{{ f.prefix }}-name" class="brand_attribute_name">{{ f.name.value }}</span>
                    <span id="{{ f.prefix }}-premium" class="brand_attributes-premium"
                          data-premium_type={{ f.premium_type.value }}
                          data-premium_amount={{ f.premium_amount.value }}>
                        {% if wizard.form.normal_price.value %}
                            <span>{% trans "Premium pricre" %}:</span>
                            <span>{% calc_premium_price f.premium_type.value f.premium_amount.value wizard.form.normal_price.value %}</span>
                            <span class="premium_currency_marker"></span>
                        {% else %}
                            <span>{% trans "Premium" %}:</span>
                            {% if f.premium_type.value == 'percentage' %}
                                {% if f.premium_amount.value  %}
                                    <span>{{ f.premium_amount.value }}%</span>
                                {% else %}
                                    <span>0%</span>
                                {% endif %}
                            {% else %}
                                {% if f.premium_amount.value  %}
                                    <span>{{ f.premium_amount.value }}</span>
                                {% else %}
                                    <span>0</span>
                                {% endif %}
                                <span class="premium_currency_marker"></span>
                            {% endif %}
                        {% endif %}
                    </span>
                    <img class="classtex ba_texture_btn_change" role="button"
                         id="ba_texture_btn_change_{{ f.ba_id.value }}"
                         src="{% if f.texture.value %}{{ f.texture.value }}{% else %}{{ STATIC_URL }}/img/empty_attr.png{% endif %}"/>
                    <input class="ba_texture_upload_change" type="file" name="texture_file"
                           title="click to change brandattribute's texture image"
                           data-ba_id="{{ f.ba_id.value }}" />
                    <img class="classprod ba_preview_btn_change" role="button"
                         id="ba_preview_btn_change_{{ f.ba_id.value }}"
                         src="{% if f.preview.value %}{{ f.preview.value }}{% else %}{{ STATIC_URL }}/img/empty_attr.png{% endif %}"/>
                    <input class="ba_preview_upload_change" type="file" name="files[]"
                           title="{% trans "click to change brandattriibute's preview imgage." %}"
                           data-ba_id="{{ f.ba_id.value }}"/>
                    <a class="remove_brand_attribute" href="#">{% trans "Remove" %}</a>
                </span>
                {% endfor %}
                <!-- <input id="ba_input" type="text"/><a id="add_ba" href="#">{% trans "Add" %}</a> -->
            </span>
        </div>

    </fieldset>
{% endblock %}

{% block empty_forms %}
    <span id="brand_attribute_template_form" style="display: none;">
        <span id="{{ wizard.form.brand_attributes.empty_form.prefix }}-row" class="brand_attribute_form">
            {{ wizard.form.brand_attributes.empty_form.name }}
            {{ wizard.form.brand_attributes.empty_form.ba_id }}
            {{ wizard.form.brand_attributes.empty_form.texture }}
            {{ wizard.form.brand_attributes.empty_form.preview }}
            {{ wizard.form.brand_attributes.empty_form.preview_pk }}
            {{ wizard.form.brand_attributes.empty_form.premium_type }}
            {{ wizard.form.brand_attributes.empty_form.premium_amount }}
            <input style="display: none;" type="checkbox" name="{{ wizard.form.brand_attributes.empty_form.DELETE.html_name }}" id="{{ wizard.form.brand_attributes.empty_form.DELETE.auto_id }}">
            <span id="{{ wizard.form.brand_attributes.empty_form.prefix }}-name" class="brand_attribute_name"></span>
            <span class="brand_attributes-premium" id="{{ wizard.form.brand_attributes.empty_form.prefix }}-premium"></span>
            <img class="classtext" id="{{ wizard.form.brand_attributes.empty_form.texture.auto_id }}-img">
            <img class="classprod" id="{{ wizard.form.brand_attributes.empty_form.preview.auto_id }}-img">
            <a class="remove_brand_attribute" href="#">{% trans "Remove" %}</a>
        </span>
    </span>
    <span id="type_attribute_price_template_form" style="display: none;">
        {% with wizard.form.type_attribute_prices.empty_form as tap_empty %}
        <span id="{{ tap_empty.prefix }}-row" class="type_attribute_price_form">
            {{ tap_empty.tap_id }}
            {{ tap_empty.type_attribute }}
            {{ tap_empty.type_attribute_price }}
            <input style="display: none;" type="checkbox" name="{{ tap_empty.DELETE.html_name }}" id="{{ tap_empty.DELETE.auto_id }}">
            <span id="{{ tap_empty.prefix }}-type_attribute" class="type_attribute_value"></span>
            <span id="{{ tap_empty.prefix }}-type_attribute_name" class="type_attribute_name"></span>
            <span id="{{ tap_empty.prefix }}-type_attribute_price" class="type_attribute_price"></span>
            <span id="{{ tap_empty.prefix }}-type_attribute_price_cur" class="type_attribute_price_currency"></span>
            <span class="remove_type_attribute_price">{% trans "Remove" %}</span>
        </span>
        {% endwith %}
    </span>
    <span id="normal_price_template_form" style="display: none;">
        <span class="normal_price_name">{% trans "Price" %}</span>
        <span class="normal_price_price"></span>
        <span class="normal_price_currency"></span>
        <span class="remove_normal_price">{% trans "Remove" %}</span>
    </span>
    <span id="type_attribute_weight_template_form" style="display: none;">
        {% with wizard.form.type_attribute_weights.empty_form as taw_empty %}
            <span id="{{ taw_empty.prefix }}-row" class="type_attribute_weight_form">
            {{ taw_empty.taw_id }}
            {{ taw_empty.type_attribute }}
            {{ taw_empty.type_attribute_weight}}
            <input style="display: none;" type="checkbox" name="{{ taw_empty.DELETE.html_name }}" id="{{ taw_empty.DELETE.auto_id }}">
            <span id="{{ taw_empty.prefix }}-type_attribute" class="type_attribute_value"></span>
            <span id="{{ taw_empty.prefix }}-type_attribute_name" class="type_attribute_name"></span>
            <span id="{{ taw_empty.prefix }}-type_attribute_weight" class="type_attribute_weight"></span>
            <span id="{{ taw_empty.prefix }}-type_attribute_weight_unit" class="type_attribute_weight_unit"></span>
            <span class="remove_type_attribute_weight">{% trans "Remove" %}</span>
        </span>
        {% endwith %}
    </span>
    <span id="standard_weight_template_form" style="display: none;">
        <span class="standard_weight_name">{% trans "Standard Weight" %}</span>
        <span class="standard_weight"></span>
        <span class="standard_weight_unit"></span>
        <span class="remove_standard_weight">{% trans "Remove" %}</span>
    </span>
    <span id="product_picture_template_form" style="display: none;">
        <span id="{{ wizard.form.pictures.empty_form.prefix }}-row" class="product_picture_form visuelProd">
            {{ wizard.form.pictures.empty_form.pk }}
            {{ wizard.form.pictures.empty_form.thumb_url }}
            {{ wizard.form.pictures.empty_form.url }}
            {{ wizard.form.pictures.empty_form.sort_order }}
            <a id="{{ wizard.form.pictures.empty_form.prefix }}-link"><img id="{{ wizard.form.pictures.empty_form.prefix }}-img"/></a>
        </span>
    </span>
    <div id="add_new_brand_dialog" style="display: none;">
        <form id="add_new_brand_form" action="{% url "add_new_brand" %}" method="post">{% csrf_token %}
            {{ product_brand_form.as_p }}
            <input type="submit" value="{% trans "Create Brand" %}"/>
        </form>
    </div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
    jQuery(
        //JQuery的日历控件汉化
        function($){
            $.datepicker.regional['zh_CN'] = {
                clearText: '清除',

                clearStatus: '清除已选日期',
                closeText: '关闭',

                closeStatus: '不改变当前选择',
                prevText: '&lt;上月',

                prevStatus: '显示上月',
                nextText: '下月&gt;',

                nextStatus: '显示下月',
                currentText: '今天',

                currentStatus: '显示本月',
                monthNames: ['1月','2月','3月','4月','5月','6月',
                '7月','8月','9月','10月','11月','12月'],
                monthNamesShort: ['一','二','三','四','五','六',
                '七','八','九','十','十一','十二'],
                monthStatus: '选择月份', yearStatus: '选择年份',
                weekHeader: '周', weekStatus: '年内周次',
                dayNames: ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'],
                dayNamesShort: ['周日','周一','周二','周三','周四','周五','周六'],
                dayNamesMin: ['日','一','二','三','四','五','六'],
                dayStatus: '设置 DD 为一周起始',

                dateStatus: '选择 m月 d日, DD',
                dateFormat: 'yy-mm-dd',   //日期格式化形式

                firstDay: 7,
                initStatus: '请选择日期',

                showMonthAfterYear: true,
                yearSuffix: '年',

                isRTL: false
            };
            $.datepicker.setDefaults($.datepicker.regional[_get_datepicker_locale("{{ LANGUAGE_CODE }}")]);
        }
    );

    $(document).ready(function(){
        {# ready the currency mark #}
        currency_changed();
    });

    /********************** Product Picture ***********************/
    function addProductPicture(result) {
        var nb_of_forms = $("#{{ wizard.form.pictures.management_form.TOTAL_FORMS.auto_id }}").val();
        var form = $("#product_picture_template_form").html();
        form = form.replace(/__prefix__/g, nb_of_forms.toString()); // counting start from 0, so just use nb_of_forms here
        var picture_pk = "#{{ wizard.form.pictures.empty_form.pk.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var thumb_url = "#{{ wizard.form.pictures.empty_form.thumb_url.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var url = "#{{ wizard.form.pictures.empty_form.url.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var sort_order = "#{{ wizard.form.pictures.empty_form.sort_order.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var link = "#{{ wizard.form.pictures.empty_form.prefix }}-link".replace(/__prefix__/g, nb_of_forms.toString());
        var img = "#{{ wizard.form.pictures.empty_form.prefix }}-img".replace(/__prefix__/g, nb_of_forms.toString());
        if (nb_of_forms >= 2 && !$("#existing_pp").hasClass("horizontal_pp")) {
            $("#existing_pp").addClass("horizontal_pp");
        }
        $("#existing_pp").append(form);
        $("#existing_pp").sortable("refresh");
        $(picture_pk).val(result.pk);
        $(thumb_url).val(result.thumb_url);
        $(url).val(result.url);
        $(sort_order).val($("#existing_pp").find("span.product_picture_form").length);
        $(link).attr('href', result.url);
        $(img).attr('src', result.thumb_url);

        nb_of_forms++;
        $("#{{ wizard.form.pictures.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);

        $("#preview-product-picture").html(result.preview_html);
    }

    var sale_img_upload_max_size = {{ sale_img_upload_max_size }};
    var sale_img_upload_max_size_err = "{% trans "File exceeds maximum allowed size of 1MB" %}";
    function _validate_max_file_size(file) {
        if (file.size > sale_img_upload_max_size) {
            alert(sale_img_upload_max_size_err);
            return false;
        }
        return true;
    }
    $("#pp_upload").fileupload({
        dataType: 'json',
        url: "{% url 'upload_product_picture' %}",
        dropZone: $("#product_pictures"),
        namespace: 'product_pictures',
        add: function(e, data) {
            if (_validate_max_file_size(data.files[0])) {
                $.each(data.files, function(key, file) {
                    var id = file.name.replace(/\W+/g, '-');
                    var to_append = '<li id="pp_'+id+'">'+file.name+' <b></b></li>';
                    $("#pp_queue").append(to_append);
                });
                data.submit();
            }
        },
        progress: function(e, data) {
            $.each(data.files, function(key, file) {
                var id = file.name.replace(/\W+/g, '-');
                var percentage = parseInt(data.loaded/data.total*100, 10);
                $("#pp_"+id+" b").html(percentage+"%");
            });
        },
        done: function(e, data) {
            if (data.result.status == 'ok') {
                addProductPicture(data.result);
            } else if (data.result.status == 'max_limit_error'){
                alert(sale_img_upload_max_size_err);
            } else {
                alert("{% trans "Error happened when uploading, please try later, or contact system admin." %}");
            }
            $.each(data.files, function(key, file) {
                var id = file.name.replace(/\W+/g, '-');
                $("#pp_"+id).remove();
            });
        },
        fail: function(e, data) {
            alert("{% trans "Error happened when uploading, please try later, or contact system admin." %}");
        }
    });

    var product_pictures = "";
    {% for pp in wizard.form.pictures %}
        product_pictures += ''+
        '<span id="{{ pp.prefix }}-row" class="product_picture_form visuelProd">'+
            '{{ pp.pk }}'+
            '{{ pp.url }}'+
            '{{ pp.thumb_url }}'+
            '{{ pp.sort_order }}'+
            '<input style="display: none;" type="checkbox" name="{{ pp.DELETE.html_name }}" id="{{ pp.DELETE.auto_id }}" {% if pp.DELETE.value == "on" %}checked="checked"{% endif %}>'+
            '<a id="{{ pp.prefix }}-link" href="{{ pp.url.value }}"><img id="{{ pp.prefix }}-img" src="{{ pp.thumb_url.value }}"/></a>'+
        '</span>';
    {% endfor %}
    if ({{ wizard.form.pictures|length }} > 2) {
        $("p#existing_pp").addClass("horizontal_pp");
    }
    $("#existing_pp").append(product_pictures);
    $("#existing_pp").sortable({
        update: function(e, ui) {
            var self = this;
            var sort_order = $(self).sortable("toArray");
            $(self).find("span.product_picture_form").each(function(){
                $(this).find("input[id^=id_product_pictures][id$=-sort_order]").val(sort_order.indexOf($(this).attr("id")));
            });
        }
    });


    function _updateBackgroundImage(selector, url) {
        $(selector).attr('src', url);
    }

    {% if product_picture %}
        {% thumbnail product_picture.picture "156x171" as im %}
            $("#preview-product-picture").html('<img style="margin:{{ im|margin:"156x171" }}" src="{{ im.url }}" alt="{% trans "Product picture" %} {{ context.name }}" width="{{ im.x }}" height="{{ im.y }}"/>');
        {% endthumbnail %}
    {% endif %}


    /********************** Brand Attributes ***********************/
    function _updateData(dic) {
        var data = $("#add_ba_form").data("ba_data");
        if (data == undefined) {
            data = {};
        }
        for (i in dic) {
            if (i != undefined) {
                data[i] = dic[i];
            }
        }
        $("#add_ba_form").data("ba_data", data);
    }

    function _getFromData(key) {
        var data = $("#add_ba_form").data("ba_data");
        if (data == undefined) { return -1; }
        if (data[key] == undefined) { return -1; }
        return data[key];
    }

    function _clearBaForm() {
        $("#ba_input").val("");
        $("#premium_type").val("percentage");
        $("#premium_amount").val("");
        calcDiscount();
        $("#add_ba_form").data("ba_data", {});
        _updateBackgroundImage($("#ba_preview_btn"), '{{ STATIC_URL }}img/empty_attr.png');
        _updateBackgroundImage($("#ba_texture_btn"), '{{ STATIC_URL }}img/empty_attr.png');
    }

    $("#ba_preview_upload").fileupload({
        dataType: 'json',
        url: "{% url 'upload_product_picture' %}",
        dropZone: $("#ba_preview_upload"),
        namespace: 'ba_preview',
        formData: {is_brand_attribute: true},
        add: function(e, data) {
            if (_validate_max_file_size(data.files[0])) {
                _updateBackgroundImage($("#ba_preview_btn"), "{{ STATIC_URL }}img/loading2.gif");
                data.submit();
            }
        },
        done: function(e, data) {
            _updateBackgroundImage($("#ba_preview_btn"), data.result.thumb_url);
            _updateData({preview_pk: data.result.pk})
        }
    });

    // change preview for existing brandattribue
    $(".ba_preview_upload_change").fileupload({
        dataType: 'json',
        url: "{% url 'upload_product_picture' %}",
        dropZone: $(this),
        namespace: 'ba_preview',
        formData: {is_brand_attribute: true},
        add: function(e, data) {
            if (_validate_max_file_size(data.files[0])) {
                _updateBackgroundImage($("#ba_preview_btn_change_" + $(this).data("ba_id")), "{{ STATIC_URL }}img/loading2.gif");
                data.submit();
            }
        },
        done: function(e, data) {
            _updateBackgroundImage($("#ba_preview_btn_change_" + $(this).data("ba_id")), data.result.thumb_url);
            $(".brand_attribute_form_" + $(this).data("ba_id")).find("input[id$='preview_pk']").val(data.result.pk);
        }
    });

    $("#ba_texture_upload").fileupload({
        dataType: 'json',
        url: "{% url 'brand_attributes_view' %}",
        dropZone: $("#ba"),
        namespace: 'ba_texture',
        formData: {pk: _getFromData("texture_pk")},
        add: function(e, data) {
            if (_validate_max_file_size(data.files[0])) {
                _updateBackgroundImage($("#ba_texture_btn"), "{{ STATIC_URL }}img/loading2.gif");
                data.submit();
            }
        },
        done: function(e, data) {
            _updateBackgroundImage($("#ba_texture_btn"), data.result.texture_thumb);
            _updateData({ba_pk: -1, texture_pk: data.result.pk, type_pk: 'new'});
        }
    });

    // change texture for existing brandattribue
    $(".ba_texture_upload_change").fileupload({
        dataType: 'json',
        url: "{% url 'brand_attributes_view' %}",
        dropZone: $(this),
        namespace: 'ba_texture',
        add: function(e, data) {
            if (_validate_max_file_size(data.files[0])) {
                var img_el = $("#ba_texture_btn_change_" + $(this).data("ba_id"));
                var old_src = img_el.attr("src");
                _updateBackgroundImage(img_el, "{{ STATIC_URL }}img/loading2.gif");
                if (confirm("{% trans "Are you sure you want to change the texture of this existing brand attribute?" %}" +
                            "{% trans "(Note, the new texture will replace the old texture even you cancel the edit! )" %}")) {
                    data.formData={pk: $(this).data("ba_id")};
                    data.submit();
                } else {
                    _updateBackgroundImage(img_el, old_src);
                }
            }
        },
        done: function(e, data) {
            _updateBackgroundImage($("#ba_texture_btn_change_" + $(this).data("ba_id")), data.result.texture_thumb);
        }
    });

    $("#ba_input").autocomplete({
        autoFocus: true,
        source: "{% url 'brand_attributes_view' %}",
        min_length: 2,
        html: true,
        showTyping: true,
        focus: function(event, ui) {
            $(this).val(ui.item.name);
            return false;
        },
        select: function(event, ui) {
            _updateData({name: ui.item.name,
                         ba_pk: ui.item.value,
                         premium_type: ui.item.premium_type,
                         premium_amount: ui.item.premium_amount,
                         texture_pk: ui.item.value,
                         type_pk: 'exist'});
            $(this).val(ui.item.name);
            $(this).siblings("#premium_amount").val(ui.item.premium_amount);
            $(this).siblings("#premium_type").val(ui.item.premium_type);
            calcDiscount();
            $(this).focusout();
            _updateBackgroundImage($("#ba_texture_btn"), ui.item.texture);
            return false;
        }
    });

    $("#ba").change(function(){
        _updateData({name: $("#ba_input").val(),
                     premium_type:$("#premium_type").val(),
                     premium_amount:$("#premium_amount").val(),
                     ba_pk: -1})
    });

    function render_premium_result(premium_price_node, premium_type, premium_amount){
        $(premium_price_node).fadeOut(function() {
            premium_price_node.html("");
            var selected_cur = $("#{{wizard.form.currency.auto_id}} option:selected").text();
            var normal_price = parseFloat($("#{{ wizard.form.normal_price.auto_id }}").val());
            premium_amount = parseFloat(premium_amount);
            if (normal_price) {
                $("<span>").html('{% trans "Premium price" %}:')
                        .appendTo(premium_price_node);
                $("<span>").html(_calc_premium_price(premium_type, premium_amount, normal_price))
                        .appendTo(premium_price_node);
                $("<span>").addClass("premium_currency_marker")
                        .html(selected_cur)
                        .appendTo(premium_price_node);
            } else {
                $("<span>").html('{% trans "Premium" %}:')
                        .appendTo(premium_price_node);
                premium_amount = premium_amount || 0;
                if (premium_type == 'percentage') {
                    $("<span>").html(premium_amount + "%")
                            .appendTo(premium_price_node);
                } else {
                    $("<span>").html(premium_amount)
                            .appendTo(premium_price_node);
                    $("<span>").addClass("premium_currency_marker")
                            .html(selected_cur)
                            .appendTo(premium_price_node);
                }
            }
            premium_price_node.attr('data-premium_type', premium_type);
            premium_price_node.attr('data-premium_amount', premium_amount);

        }).fadeIn();
    };

    $("#add_ba").click(function(e) {
        if (!$("#ba_input").val()) {
            alert('{% trans "Attribute name can not be left blank." %}');
            e.preventDefault();
            return false;
        }
        _updateData({name: $("#ba_input").val(),
                     premium_type:$("#premium_type").val(),
                     premium_amount:$("#premium_amount").val(),
                     ba_pk: -1});
        var nb_of_forms = $("#{{ wizard.form.brand_attributes.management_form.TOTAL_FORMS.auto_id }}").val();
        var form = $("#brand_attribute_template_form").html();
        form = form.replace(/__prefix__/g, nb_of_forms.toString()); // counting start from 0, so just use nb_of_forms here
        var ba_id = "#{{ wizard.form.brand_attributes.empty_form.ba_id.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var name = "#{{ wizard.form.brand_attributes.empty_form.name.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var span_name = "#{{ wizard.form.brand_attributes.empty_form.prefix }}-name".replace(/__prefix__/g, nb_of_forms.toString());
        var premium_type = "#{{ wizard.form.brand_attributes.empty_form.premium_type.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var premium_amount = "#{{ wizard.form.brand_attributes.empty_form.premium_amount.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var span_premium_price = "#{{ wizard.form.brand_attributes.empty_form.prefix }}-premium".replace(/__prefix__/g, nb_of_forms.toString());
        var texture = "#{{ wizard.form.brand_attributes.empty_form.texture.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var preview = "#{{ wizard.form.brand_attributes.empty_form.preview.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var texture_img = "#{{ wizard.form.brand_attributes.empty_form.texture.auto_id }}-img".replace(/__prefix__/g, nb_of_forms.toString());
        var preview_img = "#{{ wizard.form.brand_attributes.empty_form.preview.auto_id }}-img".replace(/__prefix__/g, nb_of_forms.toString());
        var preview_pk = "#{{ wizard.form.brand_attributes.empty_form.preview_pk.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        // if ($("#ba_input").attr('ba_id')) {
        //     $("#brand_attributes").append(form);
        //     $(ba_id).val($("#ba_input").attr('ba_id'));
        //     $(name).val($("#ba_input").val());
        //     $(span_name).html($("#ba_input").val());
        //     $("#ba_input").val("");
        //     $("#ba_input").removeAttr("ba_id");
        //     nb_of_forms++;
        //     $("#{{ wizard.form.brand_attributes.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);
        // } else if ($("#ba_input").val()) {

        var data_send = $("#add_ba_form").data("ba_data");
        if (data_send.ba_pk == -1 && data_send.texture_pk != undefined) {
            data_send.pk = data_send.texture_pk;
        } else if (data_send.ba_pk != undefined) {
            data_send.pk = data_send.ba_pk;
        } else {

            data_send.pk = -1;
        }

        $.post("{% url 'brand_attributes_view' %}",
            data_send,
            function(data) {
                if (data.success) {
                    $('#ba_error').hide().empty();
                    $("#brand_attributes").append(form);
                    $(ba_id).val(data.pk);
                    $(texture).val(data.texture_thumb);
                    $(texture_img).attr('src', data.texture_thumb);
                    $(preview).val(data.preview_thumb);
                    $(preview_img).attr('src', data.preview_thumb);
                    $(preview_pk).val(data.preview_pk);
                    $(name).val($("#ba_input").val());
                    $(span_name).html($("#ba_input").val());
                    $(premium_type).val($("#premium_type").val());
                    $(premium_amount).val($("#premium_amount").val());
                    render_premium_result($(span_premium_price),
                                          $('#premium_type').val(),
                                          $('#premium_amount').val());
                    nb_of_forms++;
                    $("#{{ wizard.form.brand_attributes.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);
                    _clearBaForm();
                } else {
                    $('#ba_error').show().append("<li>" + data.err + "</li>");
                }
            }
        );
        return false;
    });

    $(".remove_brand_attribute").live('click', function(){
        var ba = $(this).parents(".brand_attribute_form:first");
        ba.hide();
        var delete_input_id = "#id_"+ ba.attr('id').replace('-row', '-DELETE');
        $(delete_input_id).attr('checked', 'checked');
        return false;
    });


    /********************** Add New Brand ***********************/
    $("#add_new_brand_form").ajaxForm({
        //target: $("#{{ wizard.form.brand.auto_id }}"),
        success: function(responseText) {
            if(responseText.substring(0,5)=="ERROR")
            {
                $("#brand_new_error").html(responseText)
                $("#brand_new_error").show();
            }
            else
            {
                $("#{{ wizard.form.brand.auto_id }}").html(responseText)
                $("#brand_new_error").hide();
            }
            $("#add_new_brand_dialog").dialog("close");

        }
    });

    $("#add_new_brand").click(function(){
        $("#add_new_brand_dialog").dialog({
            modal: true,
            title: "{% trans "Add a new brand" %}",
            buttons: {
                "Cancel": function() {
                    $(this).dialog("close");
                }
            }
        });
        return false;
    });

    $("#{{ wizard.form.brand.auto_id }}").change(function(elmt){
        var brand_id = $("#{{ wizard.form.brand.auto_id }} :selected").val();
        if (brand_id) {
            $("#preview-{{ wizard.form.brand.auto_id }}").html("{% trans "Loading..." %}");
            $("#preview-{{ wizard.form.brand.auto_id }}").load("{% url 'get_brand_logo' %}"+brand_id+'/');
        }
    });


    /********************** Discount ***********************/
    function _is_use_item_type_price() {
        return ($("span.normal_price_form:visible").length < 1 &&
                    $("span.type_attribute_price_form:visible").length > 0);
    }

    function _get_lowest_type_attribute_price() {
        var ta_prices = new Array();
        $("span.type_attribute_price_form:visible").each(function(){
            ta_prices.push(parseFloat($(this).find(".type_attribute_price").text()));
        });
        return ta_prices.length > 1 ? Math.min.apply(Math, ta_prices) : Math.min(ta_prices);
    }
    function _calc_discount_price(discount_type, discount, base_price) {
        if (discount_type == "percentage") { //percentage
            var tmp = base_price - (base_price * (discount / 100))
            return Math.round(tmp*100 +((tmp*1000%10>4)?1:0))/100;
        } else {
            return base_price - discount;
        }
    }
    function _calc_premium_price(premium_type, premium_amount, price) {
        if (premium_amount) {
            if (premium_type == "percentage") { //percentage
                var tmp = price + (price * (premium_amount / 100))
                return Math.round(tmp*100 +((tmp*1000%10>4)?1:0))/100;
            } else {
                return price + premium_amount;
            }
        } else {
            return price;
        }
    }
    function calcDiscount() {
        var use_item_type_price = _is_use_item_type_price();

        var discount = parseFloat($("#{{ wizard.form.discount.auto_id }}").val());
        if (isNaN(discount)) discount = 0;
        var discount_type = $("#{{ wizard.form.discount_type.auto_id }}").val();

        var discount_price_str_input = $("#{{ wizard.form.preview_discount_price_str.auto_id }}");
        var base_price_input = $("#{{ wizard.form.preview_base_price.auto_id }}");
        var discount_preview = $("#preview-{{ wizard.form.preview_discount_price_str.auto_id }}");
        var base_price_preview = $("#preview-{{ wizard.form.preview_base_price.auto_id }}");

        var selected_cur = $("#{{wizard.form.currency.auto_id}} option:selected").text();
        $("#discount_marker").html(discount_type == "percentage" ? "%": selected_cur);

        var premium_type = $("#premium_type").val();
        $("#premium_marker").html(premium_type == "percentage" ? "%": selected_cur);

        if (use_item_type_price) {
            var lowest_type_attribute_price = _get_lowest_type_attribute_price();
            var start_price = _calc_discount_price(discount_type, discount, lowest_type_attribute_price);

            // disable discount and premiums preview if there is no Unified price.
            $("span#result").hide();
            $("span#premium_result").hide();

            // preview start price on the right-preview.
            var display_discount_price = "{% trans "Starting at " %}"
                    + (start_price > 0 ? start_price : lowest_type_attribute_price);
            base_price_input.val(lowest_type_attribute_price);
            base_price_preview.html(lowest_type_attribute_price + selected_cur);
            discount_price_str_input.val(display_discount_price);
            discount_preview.html(display_discount_price + selected_cur);
        } else {
            var normal_price = parseFloat($("#{{ wizard.form.normal_price.auto_id }}").val());
            var new_price = _calc_discount_price(discount_type, discount, normal_price);
            var premium_amount = parseFloat($("#premium_amount").val());
            var premium_price = _calc_premium_price(premium_type, premium_amount, new_price);

            $("span#result").show();
            $("span#premium_result").show();

            var display_price = new_price > 0 ? new_price : normal_price;
            if (isNaN(normal_price)) normal_price = "{% trans "N/A" %}";
            if (isNaN(display_price)) display_price = "{% trans "N/A" %}";
            $("#discount_price").html(display_price);
            base_price_input.val(normal_price);
            base_price_preview.html(normal_price + "&nbsp;" + selected_cur);
            discount_price_str_input.val(display_price);
            discount_preview.html(display_price + "&nbsp;" + selected_cur);

            if (premium_price > 0) {
                $("#premium_price_val").val(parseFloat(premium_price));
                $("#premium_price").html(parseFloat(premium_price));
            } else {
                if (new_price > 0) {
                    $("#premium_price_val").val(parseFloat(new_price));
                    $("#premium_price").html(new_price);
                }
                else {
                    $("#premium_price_val").val("");
                    $("#premium_price").html("{% trans "N/A" %}");
                }
            }
        }
    }

    $("#{{ wizard.form.discount_type.auto_id }}").change(function(){
        calcDiscount();
    });
    $("#{{ wizard.form.normal_price.auto_id }}").change(function(elmt){
        calcDiscount();
    });
    $("#{{ wizard.form.discount.auto_id }}").change(function(elmt){
        calcDiscount();
    });
    $("#premium_type").change(function(){
        calcDiscount();
    });
    $("#premium_amount").change(function(){
        calcDiscount();
    });


    /********************** Update Product Preveiw ***********************/
    $("#main_form").change(function(elmt){
        updateProductPreview(elmt);
    });

    function updateProductPreview(elmt) {
        var name = $("#{{ wizard.form.name.auto_id }}").val();
        var description = $("#{{ wizard.form.description.auto_id }}").val();
        var valid_to = $("#{{ wizard.form.valid_to.auto_id }}").val();
        var discount = $("#{{ wizard.form.discount.auto_id }}").val();
        var discount_type = $("#{{ wizard.form.discount_type.auto_id }}").val();
        var selected_cur = $("#{{wizard.form.currency.auto_id}} option:selected").text();
        var discount_price = $("#{{ wizard.form.preview_discount_price_str.auto_id }}").val();
        if (isNaN(discount_price)) discount_price = "{% trans "N/A" %}";
        var base_price = $("#{{ wizard.form.preview_base_price.auto_id }}").val();
        if (isNaN(base_price)) base_price = "{% trans "N/A" %}";

        $("#preview-{{ wizard.form.name.auto_id }}").html(name);
        $("#preview-{{ wizard.form.description.auto_id }}").html(description);
        if (valid_to) {
            $("#preview-{{ wizard.form.valid_to.auto_id }}").html(valid_to).parents("span:first").show();
        } else {
            $("#preview-{{ wizard.form.valid_to.auto_id }}").html("").parents("span:first").hide();
        }
        $("#preview-{{ wizard.form.discount.auto_id }}").html(discount + (discount_type == "percentage" ? "%" : selected_cur));
        $("#preview-{{ wizard.form.preview_discount_price_str.auto_id }}").html(discount_price + "&nbsp;" + selected_cur);
        $("#preview-{{ wizard.form.preview_base_price.auto_id }}").html(base_price + "&nbsp;" + selected_cur);
    }

    function update_ba_premium() {
        $('.brand_attributes-premium').each(function (){
            var premium_type = $(this).attr('data-premium_type');
            var premium_amount = $(this).attr('data-premium_amount');

            if (premium_type && premium_amount) {
                render_premium_result($(this), premium_type, premium_amount);
            }
        });
    }

    /********************** Type Attribute Price ***********************/
    $("#add_tap").click(function(e) {
        // blank price
        var ta_price = $("#type_attribute_price_input").val();
        if (!ta_price) {
            alert("{% trans "The price can not be left blank." %}");
            e.preventDefault();
            return false;
        }

        var select_ta = $("#type_attribute_selector").val();
        var select_ta_name = $("#type_attribute_selector option:selected").text();
        var select_cur = $("#{{wizard.form.currency.auto_id}} option:selected").text();


        // NORMAL PRICE
        if (select_ta == 0) {
            // Normal price has been added.
            if ($("#type_attribute_prices span.normal_price_price").length > 0) {
                alert("The {% trans "Unified price" %} has been added!");
                return false;
            }

            // Add normal price, fill input values and display
            $("<span>").addClass("normal_price_form")
                       .append($("#normal_price_template_form").html())
                       .appendTo($("#type_attribute_prices"));
            $("#{{ wizard.form.normal_price.auto_id }}").val(ta_price).change();
            $("#type_attribute_prices span.normal_price_price").text(ta_price);
            $("#type_attribute_prices span.normal_price_currency").text(select_cur);
            update_ba_premium();
            return false;
        }


        // TYPE ATTRIBUTE PRICE
        {% with wizard.form.type_attribute_prices.empty_form as tap_empty %}
        // this type attribute price has been added.
        if ($("#type_attribute_prices span.type_attribute_price_form:visible span.type_attribute_value:[data-value="+select_ta+"]").length > 0) {
            alert("The price of \"" + select_ta_name + "\" has been added!");
            return false;
        }
        // add type attribute price
        var nb_of_forms = $("#{{ wizard.form.type_attribute_prices.management_form.TOTAL_FORMS.auto_id }}").val();
        var nb_of_forms_str = nb_of_forms.toString();
        var form = $("#type_attribute_price_template_form").html();
        form = replace_form_prefix(form, nb_of_forms_str);

        var tap_id_input = replace_form_prefix("#{{ tap_empty.tap_id.auto_id }}", nb_of_forms_str);
        var type_attribute_input = replace_form_prefix("#{{ tap_empty.type_attribute.auto_id }}", nb_of_forms_str);
        var type_attribute_price_input = replace_form_prefix("#{{ tap_empty.type_attribute_price.auto_id }}", nb_of_forms_str);
        var ta_span = replace_form_prefix("#{{ tap_empty.prefix }}-type_attribute", nb_of_forms_str);
        var ta_name_span = replace_form_prefix("#{{ tap_empty.prefix }}-type_attribute_name", nb_of_forms_str);
        var tap_span = replace_form_prefix("#{{ tap_empty.prefix }}-type_attribute_price", nb_of_forms_str);
        var tapc_span = replace_form_prefix("#{{ tap_empty.prefix }}-type_attribute_price_cur", nb_of_forms);
        {% endwith %}

        $("#type_attribute_prices").append(form);
        $(tap_id_input).val(-1);
        $(type_attribute_input).val(select_ta);
        $(type_attribute_price_input).val(ta_price);
        $(ta_span).attr("data-value", select_ta);
        $(ta_name_span).text(select_ta_name);
        $(tap_span).text(ta_price);
        $(tapc_span).text(select_cur);

        nb_of_forms++;
        $("#{{ wizard.form.type_attribute_prices.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);

        // Remove normal price option and input
        $("#type_attribute_selector option[value=0]").remove();
        $("span.normal_price_form").remove();
        $("#{{ wizard.form.normal_price.auto_id }}").val("").change();
        update_ba_premium();

        return false;
    });

    $("span.remove_type_attribute_price").live("click", function(){
        $(this).siblings("input:checkbox[id*=DELETE]").prop("checked", true);
        $(this).parent().hide();
        // Reappear normal price option
        if ($("span.type_attribute_price_form:visible").length < 1 &&
                $("#type_attribute_selector option[value=0]").length < 1) {
            $("#type_attribute_selector").prepend($("<option>", {value: 0, text: "{% trans "Unified price" %}"}));
        }
        calcDiscount();
    });
    $("span.remove_normal_price").live("click", function(){
        $("#{{ wizard.form.normal_price.auto_id }}").val("").change();
        $(this).parent().remove();
    });


    /********************** Type Attribute Weight ***********************/
    $("#add_taw").click(function(e) {
        // blank weight
        var ta_weight = $("#type_attribute_weight_input").val();
        if (!ta_weight) {
            alert("{% trans "The weight can not be left blank." %}");
            e.preventDefault();
            return false;
        }

        var select_ta = $("#type_attribute_weight_selector").val();
        var select_ta_name = $("#type_attribute_weight_selector option:selected").text();
        var select_wu = $("#{{wizard.form.weight_unit.auto_id}} option:selected").text();

        // Standard Weight
        if (select_ta == 0) {
            // Standard weight has been added.
            if ($("#type_attribute_weights span.standard_weight").length > 0) {
                alert("The {% trans "Standard Weight" %} has been added!");
                return false;
            }

            // Add standard weight, fill input values and display
            $("<span>").addClass("standard_weight_form")
                    .append($("#standard_weight_template_form").html())
                    .appendTo($("#type_attribute_weights"));
            $("#{{ wizard.form.standard_weight.auto_id }}").val(ta_weight).change();
            $("#type_attribute_weights span.standard_weight").text(ta_weight);
            $("#type_attribute_weights span.standard_weight_unit").text(select_wu);
            return false;
        }

        // TYPE ATTRIBUTE WEIGHT
        {% with wizard.form.type_attribute_weights.empty_form as taw_empty %}
            // this type attribute weight has been added.
            if ($("#type_attribute_weights span.type_attribute_weight_form:visible span.type_attribute_value:[data-value="+select_ta+"]").length > 0) {
                alert("The weight of \"" + select_ta_name + "\" has been added!");
                return false;
            }
            // add type attribute weight
            var nb_of_forms = $("#{{ wizard.form.type_attribute_weights.management_form.TOTAL_FORMS.auto_id }}").val();
            var nb_of_forms_str = nb_of_forms.toString();
            var form = $("#type_attribute_weight_template_form").html();
            form = replace_form_prefix(form, nb_of_forms_str);

            var taw_id_input = replace_form_prefix("#{{ taw_empty.taw_id.auto_id }}", nb_of_forms_str);
            var type_attribute_input = replace_form_prefix("#{{ taw_empty.type_attribute.auto_id }}", nb_of_forms_str);
            var type_attribute_weight_input = replace_form_prefix("#{{ taw_empty.type_attribute_weight.auto_id }}", nb_of_forms_str);
            var ta_span = replace_form_prefix("#{{ taw_empty.prefix }}-type_attribute", nb_of_forms_str);
            var ta_name_span = replace_form_prefix("#{{ taw_empty.prefix }}-type_attribute_name", nb_of_forms_str);
            var taw_span = replace_form_prefix("#{{ taw_empty.prefix }}-type_attribute_weight", nb_of_forms_str);
            var tawu_span = replace_form_prefix("#{{ taw_empty.prefix }}-type_attribute_weight_unit", nb_of_forms);
        {% endwith %}

        $("#type_attribute_weights").append(form);
        $(taw_id_input).val(-1);
        $(type_attribute_input).val(select_ta);
        $(type_attribute_weight_input).val(ta_weight);
        $(ta_span).attr("data-value", select_ta);
        $(ta_name_span).text(select_ta_name);
        $(taw_span).text(ta_weight);
        $(tawu_span).text(select_wu);

        nb_of_forms++;
        $("#{{ wizard.form.type_attribute_weights.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);

        // Remove standard weight option and input
        $("#type_attribute_weight_selector option[value=0]").remove();
        $("span.standard_weight_form").remove();
        $("#{{ wizard.form.standard_weight.auto_id }}").val("").change();

        return false;
    });

    $("span.remove_type_attribute_weight").live("click", function(){
        $(this).siblings("input:checkbox[id*=DELETE]").prop("checked", true);
        $(this).parent().hide();
        // Reappear standard weight option
        if ($("span.type_attribute_weight_form:visible").length < 1 &&
                $("#type_attribute_weight_selector option[value=0]").length < 1) {
            $("#type_attribute_weight_selector").prepend($("<option>", {value: 0, text: "{% trans "Standard Weight" %}"}));
        }
    });
    $("span.remove_standard_weight").live("click", function(){
        $("#{{ wizard.form.standard_weight.auto_id }}").val("").change();
        $(this).parent().remove();
    });

    {# weight unit dropdown change event#}
    function weight_unit_changed() {
        var selected_cur = $("#{{wizard.form.weight_unit.auto_id}} option:selected").text();
        $("#taw_weight_unit").html(selected_cur);
        $("#type_attribute_weights span.standard_weight_unit").text(selected_cur);
        $(".type_attribute_weight_unit").each(function(){
            $(this).text(selected_cur);
        });
    }
    $("#{{wizard.form.weight_unit.auto_id}}").change(function(e){
        weight_unit_changed();
    });

    /********************** Utils ***********************/
    // Get product types by selected product category
    function getTypeOptions(cat_id) {
        if (cat_id) {
            $.ajax({
                type: "GET",
                url: "/sales/get_product_types/" + cat_id,
                dataType:"json",
                success: function(data, textStatus){
                    $("#product_type_selector").empty();
                    $.each(data, function(i, option){
                        if (option.valid) {
                            $("#product_type_selector").append($("<option>", {value: option.value, text: option.label}));
                        } else if ("{{ wizard.form.type.value }}" != "None" && option.value == {{ wizard.form.type.value }}) {
                            $("#product_type_selector").append($("<option>", {value: option.value, text: "({% trans "invalid" %})" + option.label}));
                        }
                    });
                    if ("{{ wizard.form.type.value }}") {
                        $("#product_type_selector").val("{{ wizard.form.type.value }}").change();
                    }
                }
            });
        } else {
            $("#product_type_selector").empty();
        }
        $("#product_type_selector").change();
    }

    // Get item type attributes by selected product type
    function getItemTypeAttributeOptions(type_id) {
        $("#{{ wizard.form.type.auto_id }}").val(type_id);
        if (type_id) {
            $.ajax({
                type: "GET",
                url: "/attributes/get_item_attrs/" + type_id,
                dataType:"json",
                success: function(data, textStatus){
                    // initialise Price selector
                    $("#type_attribute_selector").empty();
                    if ($("span.type_attribute_price_form:visible").length < 1 &&
                            $("#type_attribute_selector option[value=0]").length < 1) {
                        $("#type_attribute_selector").prepend($("<option>", {value: 0, text: "{% trans "Unified price" %}"}));
                    }
                    $.each(data, function(i, option){
                        if (option.valid) {
                            $("#type_attribute_selector").append($("<option>", {value: option.value, text: option.label}));
                        }
                    });

                    // initialise weight selector
                    $("#type_attribute_weight_selector").empty();
                    if ($("span.type_attribute_weight_form:visible").length < 1 &&
                            $("#type_attribute_weight_selector option[value=0]").length < 1) {
                        $("#type_attribute_weight_selector").prepend($("<option>", {value: 0, text: "{% trans "Standard Weight" %}"}));
                    }
                    $.each(data, function(i, option){
                        if (option.valid) {
                            $("#type_attribute_weight_selector").append($("<option>", {value: option.value, text: option.label}));
                        }
                    });
                }
            });
        } else {
            $("#type_attribute_selector").empty();
            $("#type_attribute_selector").append($("<option>", {value: 0, text: "{% trans "Unified price" %}"}));
            $("#type_attribute_weight_selector").empty();
            $("#type_attribute_weight_selector").append($("<option>", {value: 0, text: "{% trans "Standard Weight" %}"}));
        }
    }

    function _get_datepicker_locale(s) {
        var l = s.split('-');
        if (l[0] == 'en') return '';
        if (l[1]) l[1] = l[1].toUpperCase();
        l = l.join('_');
        return l;
    }

    {# currency dropdown change event#}
    function currency_changed() {
        var selected_cur = $("#{{wizard.form.currency.auto_id}} option:selected").text();
        $("#id_discount_price_marker").html(selected_cur);
        $("#id_premium_price_marker").html(selected_cur);
        $("#tap_currency").html(selected_cur);
        $("#type_attribute_prices span.normal_price_currency").text(selected_cur);
        $(".type_attribute_price_currency").each(function(){
            $(this).text(selected_cur);
        });
        $(".premium_currency_marker").each(function(){
            $(this).text(selected_cur);
        });
        calcDiscount();
    }
    $("#{{wizard.form.currency.auto_id}}").change(function(e){
        currency_changed();
    });

    function replace_form_prefix(str1, str2) {
        return str1.replace(/__prefix__/g, str2);
    }

    // Those will be called when page is reloaded, for example if data validation
    // fails or we clicked "prev" from next step
    calcDiscount();
    updateProductPreview(null);
    $("#{{ wizard.form.brand.auto_id }}").change();
    if ("{{ wizard.form.category.value }}") {
        $("#{{ wizard.form.category.auto_id }}").change();
    }
    $("#{{ wizard.form.valid_from.auto_id }}").datepicker();
    $("#{{ wizard.form.valid_to.auto_id }}").datepicker({
        onSelect: function(dateText, inst) {
            $("#preview-{{ wizard.form.valid_to.auto_id }}").html(dateText).parents("span:first").show();
        }
    });

</script>
{% endblock %}
