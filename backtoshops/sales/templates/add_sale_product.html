{% extends base_template %}
{% load i18n %}
{% load get_ta_name %}
{% load get_cur_name %}
{% load calc_premium_price %}

{#Form to add product#}

{% block form %}
    {{ wizard.management_form }}
    {{ wizard.form.shop_ids }}
    <fieldset>
        <div class="p_vide formrow">
            {{ wizard.form.non_field_errors }}
        </div>

        <div class="colLeft bkcolor">
            <h3 class="sstitle">Product informations</h3>

            {{ wizard.form.name.errors }}
            <div class="formrow">
                <label for="{{ wizard.form.name.auto_id }}">{% trans wizard.form.name.label %}</label>
                {{ wizard.form.name }}
            </div>

            {{ wizard.form.brand.errors }}
            <div class="marge formrow">
                <label for="{{ wizard.form.brand.auto_id }}">{% trans "Brand name" %}</label>
                {{ wizard.form.brand }} {% trans "or" %}  <a href="#" id="add_new_brand">{% trans "Add a new brand" %}</a>
                <span id="brand_new_error" style="display:none"></span>
            </div>

            {{ wizard.form.category.errors }}
            <div class="formrow">
                <label for="{{ wizard.form.category.auto_id }}">{% trans wizard.form.category.label %}</label>
                {{ wizard.form.category }}
            </div>

            {{ wizard.form.type.errors }}
            <div class="formrow">
                <label for="{{ wizard.form.type.auto_id }}">{% trans wizard.form.type.label %}</label>
                {{ wizard.form.type }}
                <select id="product_type_selector" name="product_type_selector" onchange="getItemTypeAttributeOptions(this.value)"></select>
            </div>

            {{ wizard.form.gender.errors }}
            <div class="marge formrow">
                <label for={{ wizard.form.gender.auto_id }}>{% trans wizard.form.gender.label %}</label>
                {{ wizard.form.gender }}
            </div>

            {{ wizard.form.weight_unit.errors }}
            <div class="formrow small">
                <label for="{{ wizard.form.weight_unit.auto_id }}">{% trans wizard.form.weight_unit.label %}</label>
                <span>{{wizard.form.weight_unit}}</span>
                <input type="hidden" name="{{wizard.form.weight_unit.html_name}}" value="{{wizard.form.weight_unit.value}}" />
            </div>
            
            {{ wizard.form.standard_weight.errors }}
            <div class="marge formrow">
                {{ wizard.form.type_attribute_weights.management_form }}
                <label>{% trans "Weight" %}</label>
                <span class="contForm" id="type_attribute_weights">
                    <div id="add_taw_form">
                        <select id="type_attribute_weight_selector" name="type_attribute_weight_selector">
                            <option value="0">{% trans "Standard Weight" %}</option>
                        </select>
                        <span class="raw">></span>
                        <input id="type_attribute_weight_input" class="inputXS" type="text" name="type_attribute_weight_input"/>
                        <span id="taw_weight_unit">{{ wizard.form.weight_unit.value }}</span>
                        <a id="add_taw" href="#">{% trans "Add" %}</a>
                    </div>

                    {{ wizard.form.standard_weight }}
                    {% if wizard.form.standard_weight.value %}
                        <span class="standard_weight_form">
                        <span class="standard_weight_name">{% trans "Standard Weight" %}</span>
                        <span class="standard_weight">{{ wizard.form.standard_weight.value }}</span>
                        <span class="standard_weight_unit">{{ wizard.form.weight_unit.value }}</span>
                        <span class="remove_standard_weight">{% trans "Remove" %}</span>
                    </span>
                    {% endif %}
                    {% for f in wizard.form.type_attribute_weights %}
                        <span id="{{ f.prefix }}-row" class="type_attribute_weight_form" {% if f.DELETE.value %}style="display: none;"{% endif %}>
                            {{ f.taw_id }}
                            {{ f.type_attribute }}
                            {{ f.type_attribute_weight }}
                            <input style="display: none;" type="checkbox" name="{{ f.DELETE.html_name }}" id="{{ f.DELETE.auto_id }}" {% if f.DELETE.value %}checked="checked"{% endif %}>
                            <span id="{{ f.prefix }}-type_attribute" class="type_attribute_value">{{ f.type_attribute.value }}</span>
                            <span id="{{ f.prefix }}-type_attribute_name" class="type_attribute_name">{% get_ta_name f.type_attribute.value %}</span>
                            <span id="{{ f.prefix }}-type_attribute_weight" class="type_attribute_weight">{{ f.type_attribute_weight.value }}</span>
                            <span id="{{ f.prefix }}-type_attribute_weight_unit" class="type_attribute_weight_unit">{{ wizard.form.weight_unit.value }}</span>
                            <span class="remove_type_attribute_weight">{% trans "Remove" %}</span>
                        </span>
                    {% endfor %}
                </span>
            </div>

            {{ wizard.form.currency.errors }}
            <div class="formrow">
                <label for="{{ wizard.form.currency.auto_id }}">{% trans wizard.form.currency.label %}</label>
                <span>{{wizard.form.currency}}</span>
                <input type="hidden" name="{{wizard.form.currency.html_name}}" value="{{wizard.form.currency.value}}" />
            </div>

            {{ wizard.form.preview_base_price }}
            {{ wizard.form.normal_price.errors }}
            <div class="marge formrow">
                {{ wizard.form.type_attribute_prices.management_form }}
                <label>{% trans "Price" %}</label>
                <span class="contForm" id="type_attribute_prices">
                    <div id="add_tap_form">
                        <select id="type_attribute_selector" name="type_attribute_selector">
                            <option value="0">{% trans "Unified price" %}</option>
                        </select>
                        <span class="raw">></span>
                        <input id="type_attribute_price_input" class="inputXS" type="text" name="type_attribute_price_input"/>
                        <span id="tap_currency">EUR</span>
                        <a id="add_tap" href="#">{% trans "Add" %}</a>
                    </div>

                {{ wizard.form.normal_price }}
                {% if wizard.form.normal_price.value %}
                    <span class="normal_price_form">
                        <span class="normal_price_name">{% trans "Price" %}</span>
                        <span class="normal_price_price">{{ wizard.form.normal_price.value }}</span>
                        <span class="normal_price_currency">{% get_cur_name wizard.form.currency.value %}</span>
                        <span class="remove_normal_price">{% trans "Remove" %}</span>
                    </span>
                {% endif %}
                {% for f in wizard.form.type_attribute_prices %}
                    <span id="{{ f.prefix }}-row" class="type_attribute_price_form" {% if f.DELETE.value %}style="display: none;"{% endif %}>
                        {{ f.tap_id }}
                        {{ f.type_attribute }}
                        {{ f.type_attribute_price }}
                        <input style="display: none;" type="checkbox" name="{{ f.DELETE.html_name }}" id="{{ f.DELETE.auto_id }}" {% if f.DELETE.value %}checked="checked"{% endif %}>
                        <span id="{{ f.prefix }}-type_attribute" class="type_attribute_value" data-value="{{ f.type_attribute.value }}">{{ f.type_attribute.value }}</span>
                        <span id="{{ f.prefix }}-type_attribute_name" class="type_attribute_name">{% get_ta_name f.type_attribute.value %}</span>
                        <span id="{{ f.prefix }}-type_attribute_price" class="type_attribute_price">{{ f.type_attribute_price.value }}</span>
                        <span id="{{ f.prefix }}-type_attribute_price_cur" class="type_attribute_price_currency">{% get_cur_name wizard.form.currency.value %}</span>
                        <span class="remove_type_attribute_price">{% trans "Remove" %}</span>
                    </span>
                {% endfor %}
                </span>
            </div>

            {{ wizard.form.discount.errors }}
            {{ wizard.form.discount_type.errors }}
            <div class="marge formrow">
                <label for="prixBTS">{% trans "BackToShops Price" %}</label>
                <span class="contForm" id="newPrice">
                    {{ wizard.form.discount_type }}
                    {{ wizard.form.preview_discount_price_str }}
                    <span class="raw">></span>{{ wizard.form.discount }}<span id="discount_marker" class="discount_marker">%</span>
                    <span id="result">{% trans "Discounted price" %} : <strong id="discount_price">{% trans "N/A" %}</strong> <strong id="id_discount_price_marker">&nbsp;</strong></span>
                </span>
            </div>

            {{ wizard.form.valid_from.errors }}
            {{ wizard.form.valid_to.errors }}
            <div class="formrow">
                <label>{% trans "Valid through" %}</label>
                <span>{{ wizard.form.valid_from.label }}</span>{{ wizard.form.valid_from }}
                <span>{{ wizard.form.valid_to.label }}</span>{{ wizard.form.valid_to }}
            </div>

            {{ wizard.form.barcodes.management_form }}
            {{ wizard.form.barcodes.non_field_errors }}
            {{ wizard.form.externalrefs.management_form }}
            {{ wizard.form.externalrefs.non_field_errors }}
            {{ wizard.form.non_field_errors }}
        </div>

        <div class="colRight bkcolor">
            <h3 class="sstitle">{% trans "Product description" %}</h3>
                            
            {{ wizard.form.cover_url.errors }}
            <div class="marge formrow">
                <label for="{{ wizard.form.cover_url.auto_id }}">{% trans wizard.form.cover_url.label %}</label>
                <span id="upload-coverfile">
                    <a class="uploadfile">
                    {% if wizard.form.cover_url.value %}
                        <img class="cover_btn" src="{{ wizard.form.cover_url.value }}" />
                    {% else %}
                        <div>{% trans "Click or drag a file here to upload the picture" %}</div>
                        <img class="cover_btn" style="display:none"/>
                    {% endif %}
                    </a>
                    <input class="cover_upload" style="display:none" type="file" name="files[]">
                    {{ wizard.form.cover_url  }}
                    {{ wizard.form.cover_pk }}
                </span>
            </div>

            {{ wizard.form.short_description.errors }}
            <div class="formrow">
                <label for="{{ wizard.form.short_description.auto_id }}">{% trans wizard.form.short_description.label %}</label>
                {{ wizard.form.short_description }}
            </div>

            {{ wizard.form.description.errors }}
            <div class="marge formrow">
                <label for="{{ wizard.form.description.auto_id }}">{% trans wizard.form.description.label %}</label>
                {{ wizard.form.description }}
            </div>
        </div>

        <div class="clear"></div>

        <!--VISUELS PRODUITS-->
        <div id="blocProd" class="tabs">
            <ul class="tabs-header">
                <li class="base-item">
                    <a href="#base-item">{% trans "Product name" %}</a>
                </li>
                {% for ba in wizard.form.brand_attributes %}
                {% if ba.ba_id.value %}
                <li class="brand-attr">
                    <span class="delete">{% trans "Delete" %}</span>
                    <a href="#brand-attr-{{ ba.ba_id.value }}">{% trans "Add a product variant" %}</a>
                </li>
                {% endif %}
                {% endfor %}
                <li class="add-attr">
                    <a href="#brand-attr-0">{% trans "Add a product variant" %}</a>
                </li>
                <li class="gallery">
                    <a href="#gallery">{% trans "Pictures Gallery" %}</a>
                </li>
            </ul>
            
            {% include "add_sale_product_base_item.html" %}
            {{ wizard.form.brand_attributes.management_form }}
            {% for ba in wizard.form.brand_attributes %}
                {% if ba.ba_id.value %}
                    {% with b_index=forloop.counter %}
                        {% include "add_sale_product_edit_attr.html" %}
                    {% endwith %}
                {% endif %}
            {% endfor %}
            {% with ba=wizard.form.brand_attributes.empty_form %}
                {% include "add_sale_product_new_attr.html" %}
            {% endwith %}
            {% include "add_sale_product_gallery.html" %}
            
        </div>
        <!--//VISUELS PRODUITS-->

    </fieldset>
{% endblock %}

{% block empty_forms %}
    <span id="type_attribute_price_template_form" style="display: none;">
        {% with wizard.form.type_attribute_prices.empty_form as tap_empty %}
        <span id="{{ tap_empty.prefix }}-row" class="type_attribute_price_form">
            {{ tap_empty.tap_id }}
            {{ tap_empty.type_attribute }}
            {{ tap_empty.type_attribute_price }}
            <input style="display: none;" type="checkbox" name="{{ tap_empty.DELETE.html_name }}" id="{{ tap_empty.DELETE.auto_id }}">
            <span id="{{ tap_empty.prefix }}-type_attribute" class="type_attribute_value"></span>
            <span id="{{ tap_empty.prefix }}-type_attribute_name" class="type_attribute_name"></span>
            <span id="{{ tap_empty.prefix }}-type_attribute_price" class="type_attribute_price"></span>
            <span id="{{ tap_empty.prefix }}-type_attribute_price_cur" class="type_attribute_price_currency"></span>
            <span class="remove_type_attribute_price">{% trans "Remove" %}</span>
        </span>
        {% endwith %}
    </span>
    <span id="normal_price_template_form" style="display: none;">
        <span class="normal_price_name">{% trans "Price" %}</span>
        <span class="normal_price_price"></span>
        <span class="normal_price_currency"></span>
        <span class="remove_normal_price">{% trans "Remove" %}</span>
    </span>
    <span id="type_attribute_weight_template_form" style="display: none;">
        {% with wizard.form.type_attribute_weights.empty_form as taw_empty %}
            <span id="{{ taw_empty.prefix }}-row" class="type_attribute_weight_form">
            {{ taw_empty.taw_id }}
            {{ taw_empty.type_attribute }}
            {{ taw_empty.type_attribute_weight}}
            <input style="display: none;" type="checkbox" name="{{ taw_empty.DELETE.html_name }}" id="{{ taw_empty.DELETE.auto_id }}">
            <span id="{{ taw_empty.prefix }}-type_attribute" class="type_attribute_value"></span>
            <span id="{{ taw_empty.prefix }}-type_attribute_name" class="type_attribute_name"></span>
            <span id="{{ taw_empty.prefix }}-type_attribute_weight" class="type_attribute_weight"></span>
            <span id="{{ taw_empty.prefix }}-type_attribute_weight_unit" class="type_attribute_weight_unit"></span>
            <span class="remove_type_attribute_weight">{% trans "Remove" %}</span>
        </span>
        {% endwith %}
    </span>
    <span id="standard_weight_template_form" style="display: none;">
        <span class="standard_weight_name">{% trans "Standard Weight" %}</span>
        <span class="standard_weight"></span>
        <span class="standard_weight_unit"></span>
        <span class="remove_standard_weight">{% trans "Remove" %}</span>
    </span>
    <span id="barcode_template_form" style="display: none;">
        {% with wizard.form.barcodes.empty_form as bac_empty %}
            <label for="{{ bac_empty.upc.auto_id }}"></label>
            <input id="{{ bac_empty.upc.auto_id }}" type="text"  name="{{ bac_empty.upc.html_name }}" maxlength="5" value="{% if bac_empty.upc.value %}{{ bac_empty.upc.value }}{% endif %}">
            <span style="display: none;">
                {{ bac_empty.common_attribute }}
                {{ bac_empty.brand_attribute }}
                <input type="checkbox" name="{{ bac_empty.DELETE.html_name }}" id="{{ bac_empty.DELETE.auto_id }}" checked="true">
            </span>
        {% endwith %}
    </span>
    <span id="product_picture_template_form" style="display: none;">
        <li id="{{ wizard.form.pictures.empty_form.prefix }}-row" class="product_picture_form">
            {{ wizard.form.pictures.empty_form.pk }}
            {{ wizard.form.pictures.empty_form.thumb_url }}
            {{ wizard.form.pictures.empty_form.url }}
            {{ wizard.form.pictures.empty_form.sort_order }}
            <input style="display: none;" type="checkbox" name="{{ wizard.form.pictures.empty_form.DELETE.html_name }}" id="{{ ba.previews.empty_form.DELETE.auto_id }}">
            <span>
                <span class="delete">{% trans "Delete" %}</span>
                <img id="{{ wizard.form.pictures.empty_form.prefix }}-img"/>
            </span>
        </li>
    </span>
    <div id="add_new_brand_dialog" style="display: none;">
        <form id="add_new_brand_form" action="{% url "add_new_brand" %}" method="post">{% csrf_token %}
            {{ product_brand_form.as_p }}
            <input type="submit" value="{% trans "Create Brand" %}"/>
        </form>
    </div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
    jQuery(
        //JQuery的日历控件汉化
        function($){
            $.datepicker.regional['zh_CN'] = {
                clearText: '清除',

                clearStatus: '清除已选日期',
                closeText: '关闭',

                closeStatus: '不改变当前选择',
                prevText: '&lt;上月',

                prevStatus: '显示上月',
                nextText: '下月&gt;',

                nextStatus: '显示下月',
                currentText: '今天',

                currentStatus: '显示本月',
                monthNames: ['1月','2月','3月','4月','5月','6月',
                '7月','8月','9月','10月','11月','12月'],
                monthNamesShort: ['一','二','三','四','五','六',
                '七','八','九','十','十一','十二'],
                monthStatus: '选择月份', yearStatus: '选择年份',
                weekHeader: '周', weekStatus: '年内周次',
                dayNames: ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'],
                dayNamesShort: ['周日','周一','周二','周三','周四','周五','周六'],
                dayNamesMin: ['日','一','二','三','四','五','六'],
                dayStatus: '设置 DD 为一周起始',

                dateStatus: '选择 m月 d日, DD',
                dateFormat: 'yy-mm-dd',   //日期格式化形式

                firstDay: 7,
                initStatus: '请选择日期',

                showMonthAfterYear: true,
                yearSuffix: '年',

                isRTL: false
            };
            $.datepicker.setDefaults($.datepicker.regional[_get_datepicker_locale("{{ LANGUAGE_CODE }}")]);
        }
    );

    $(document).ready(function(){
        {# ready the currency mark #}
        currency_changed();
        prod_name_changed();
        set_default_option($('#{{ wizard.form.brand.auto_id }}'));
        set_default_option($('#{{ wizard.form.category.auto_id }}'));
        sort_existing_pp($('#existing_pp'));
        update_barcodes();
        update_extrefs();
        update_all_ba_premium();
    });

    function set_default_option(select_obj) {
        if (select_obj.find('option').length == 2
                && select_obj.find('option:selected').val() == ""
            || select_obj.find('option').length == 1
                && select_obj.find('option:selected').length == 0) {
            select_obj.find('option[value!=""]').selected().change();
        }
    }

    /********************** Cover Picture ***********************/
    $("#upload-coverfile").fileupload({
        dataType: 'json',
        url: "{% url 'upload_product_picture' %}",
        dropZone: $('#upload-coverfile'),
        namespace: 'coverfile',
        formData: {is_cover: true},
        add: function(e, data) {
            if (_validate_max_file_size(data.files[0])) {
                
                _updateBackgroundImage($("#upload-coverfile .cover_btn"), "{{ STATIC_URL }}img/loading2.gif");
                $("#upload-coverfile .cover_btn").show();
                $("#upload-coverfile .cover_btn").siblings('div').hide();
                data.submit();
            }
        },
        done: function(e, data) {
            _updateBackgroundImage($("#upload-coverfile .cover_btn"), data.result.thumb_url);
            $("#{{ wizard.form.cover_pk.auto_id }}").val(data.result.pk);
            $("#{{ wizard.form.cover_url.auto_id }}").val(data.result.thumb_url);
        }
    });

    /********************** Product Picture ***********************/
    function addProductPicture(result) {
        var nb_of_forms = $("#{{ wizard.form.pictures.management_form.TOTAL_FORMS.auto_id }}").val();
        var form = $("#product_picture_template_form").html();
        form = form.replace(/__prefix__/g, nb_of_forms.toString()); // counting start from 0, so just use nb_of_forms here
        var picture_pk = "#{{ wizard.form.pictures.empty_form.pk.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var thumb_url = "#{{ wizard.form.pictures.empty_form.thumb_url.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var url = "#{{ wizard.form.pictures.empty_form.url.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var sort_order = "#{{ wizard.form.pictures.empty_form.sort_order.auto_id }}".replace(/__prefix__/g, nb_of_forms.toString());
        var img = "#{{ wizard.form.pictures.empty_form.prefix }}-img".replace(/__prefix__/g, nb_of_forms.toString());
        $(form).insertBefore($("#existing_pp li.product_pictures_upload"));
        $("#existing_pp").sortable("refresh");
        $(picture_pk).val(result.pk);
        $(thumb_url).val(result.thumb_url);
        $(url).val(result.url);
        $(sort_order).val($("#existing_pp").find("li.product_picture_form").length);
        $(img).attr('src', result.thumb_url);

        nb_of_forms++;
        $("#{{ wizard.form.pictures.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);
    }

    var sale_img_upload_max_size = {{ sale_img_upload_max_size }};
    var sale_img_upload_max_size_err = "{% trans "File exceeds maximum allowed size of 1MB" %}";
    function _validate_max_file_size(file) {
        if (file.size > sale_img_upload_max_size) {
            alert(sale_img_upload_max_size_err);
            return false;
        }
        return true;
    }
    $("#pp_upload").fileupload({
        dataType: 'json',
        url: "{% url 'upload_product_picture' %}",
        dropZone: $(".product_pictures_upload"),
        namespace: 'product_pictures',
        add: function(e, data) {
            if (_validate_max_file_size(data.files[0])) {
                $.each(data.files, function(key, file) {
                    var id = file.name.replace(/\W+/g, '-');
                    var to_append = '<li id="pp_'+id+'">'+file.name+' <b></b></li>';
                    $(this).find(".pp_queue").append(to_append);
                });
                data.submit();
            }
        },
        progress: function(e, data) {
            $.each(data.files, function(key, file) {
                var id = file.name.replace(/\W+/g, '-');
                var percentage = parseInt(data.loaded/data.total*100, 10);
                $("#pp_"+id+" b").html(percentage+"%");
            });
        },
        done: function(e, data) {
            if (data.result.status == 'ok') {
                addProductPicture(data.result);
            } else if (data.result.status == 'max_limit_error'){
                alert(sale_img_upload_max_size_err);
            } else {
                alert("{% trans "Error happened when uploading, please try later, or contact system admin." %}");
            }
            $.each(data.files, function(key, file) {
                var id = file.name.replace(/\W+/g, '-');
                $("#pp_"+id).remove();
            });
        },
        fail: function(e, data) {
            alert("{% trans "Error happened when uploading, please try later, or contact system admin." %}");
        }
    });

    $("#existing_pp").sortable({
        update: function(e, ui) {
            $(this).find("li.product_picture_form").each(function(idx){
                $(this).find("input[id^=id_product_pictures][id$=-sort_order]").val(idx);
            });
        },
        cancel: ".product_pictures_upload",
    });


    function _updateBackgroundImage(selector, url) {
        $(selector).attr('src', url);
    }

    /********************** Brand Attributes ***********************/
    function _updateData(obj, dic) {
        var data = obj.data("ba_data");
        if (data == undefined) {
            data = {};
        }
        for (i in dic) {
            if (i != undefined) {
                data[i] = dic[i];
            }
        }
        obj.data("ba_data", data);
    }

    function _getFromData(obj, key) {
        var data = obj.data("ba_data");
        if (data == undefined) { return -1; }
        if (data[key] == undefined) { return -1; }
        return data[key];
    }

    function _clearBaForm(obj) {
        obj.find('#ba_error').hide().empty();
        obj.find(".ba_input").val("");
        obj.find("select[id$=premium_type]").val("percentage");
        obj.find("input[id$=premium_amount]").val("");
        calcDiscount();
        obj.data("ba_data", {});
        obj.find("input[id$=-upc]").val('');
        obj.find("input[id$=-external_id]").val('');
        obj.find('.existing_pp li:last').siblings().remove();
        $("#{{ wizard.form.brand_attributes.empty_form.previews.management_form.TOTAL_FORMS.auto_id }}").val(0);
        _updateBackgroundImage(obj.find(".ba_texture_btn"), '');
    }

    function _getBaFormCount() {
        return $("#{{ wizard.form.brand_attributes.management_form.TOTAL_FORMS.auto_id }}").val();
    }

    function _addBaFormCount() {
        var nb_of_forms = _getBaFormCount();
        nb_of_forms++;
        $("#{{ wizard.form.brand_attributes.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);
        return nb_of_forms
    }

    function addBaPreview(obj, result) {
        var prefix = obj.find("input[name=ba_prefix]").val();
        var nb_of_forms = obj.find("input[id^=id_" + prefix + "-previews-TOTAL_FORMS]").val();
        var form = obj.find("#ba_preview_template_form").html();
        var new_str = 'previews-' + nb_of_forms.toString();
        form = form.replace(/previews-__prefix__/g, new_str); // counting start from 0, so just use nb_of_forms here
        var picture_pk = "#{{ wizard.form.brand_attributes.empty_form.previews.empty_form.pk.auto_id }}".replace(/brand_attributes-__prefix__/g, prefix).replace(/previews-__prefix__/g, new_str);
        var url = "#{{ wizard.form.brand_attributes.empty_form.previews.empty_form.url.auto_id }}".replace(/brand_attributes-__prefix__/g, prefix).replace(/previews-__prefix__/g, new_str);
        var sort_order = "#{{ wizard.form.brand_attributes.empty_form.previews.empty_form.sort_order.auto_id }}".replace(/brand_attributes-__prefix__/g, prefix).replace(/previews-__prefix__/g, new_str);
        var img = "#{{ wizard.form.brand_attributes.empty_form.previews.empty_form.prefix }}-img".replace(/brand_attributes-__prefix__/g, prefix).replace(/previews-__prefix__/g, new_str);
        $(form).insertBefore(obj.find(".existing_pp li.ba_previews_upload"));
        obj.find(".existing_pp").sortable("refresh");
        obj.find(picture_pk).val(result.pk);
        obj.find(sort_order).val(obj.find(".existing_pp li.ba_preview_form").length);
        obj.find(img).attr('src', result.thumb_url);

        nb_of_forms++;
        obj.find("input[id^=id_" + prefix + "-previews-TOTAL_FORMS]").val(nb_of_forms);
    }

    function ba_events(attr_obj) {
        var prefix = attr_obj.find("input[name=ba_prefix]").val();

        attr_obj.find('.ba_input').change(function(){
            var tab_id = $(this).parents('div .visuelProd').attr('id');
            $('.tabs li.brand-attr a[href=#' + tab_id + ']').text($(this).val());
        });
        attr_obj.find('.ba_input').change();

        attr_obj.find(".existing_pp").sortable({
            update: function(e, ui) {
                $(this).find("li.ba_preview_form").each(function(idx){
                    $(this).find("input[id^=id_" + prefix + "-previews-][id$=-sort_order]").val(idx);
                });
            },
            cancel: ".ba_previews_upload",
        });

        attr_obj.find(".ba_preview_upload").fileupload({
            dataType: 'json',
            url: "{% url 'upload_product_picture' %}",
            formData: {is_brand_attribute: true},
            dropZone: attr_obj.find('.ba_previews_upload'),
            namespace: 'ba_preview',
            add: function(e, data) {
                if (_validate_max_file_size(data.files[0])) {
                    $.each(data.files, function(key, file) {
                        var id = file.name.replace(/\W+/g, '-');
                        var to_append = '<li id="pp_'+id+'">'+file.name+' <b></b></li>';
                        attr_obj.find(".pp_queue").append(to_append);
                    });
                    data.submit();
                }
            },
            progress: function(e, data) {
                $.each(data.files, function(key, file) {
                    var id = file.name.replace(/\W+/g, '-');
                    var percentage = parseInt(data.loaded/data.total*100, 10);
                    $("#pp_"+id+" b").html(percentage+"%");
                });
            },
            done: function(e, data) {
                if (data.result.status == 'ok') {
                    addBaPreview(attr_obj, data.result);
                } else if (data.result.status == 'max_limit_error'){
                    alert(sale_img_upload_max_size_err);
                } else {
                    alert("{% trans "Error happened when uploading, please try later, or contact system admin." %}");
                }
                $.each(data.files, function(key, file) {
                    var id = file.name.replace(/\W+/g, '-');
                    $("#pp_"+id).remove();
                });
                var previews_data = _getFromData(attr_obj, "previews");
                if (previews_data == -1)
                    previews_data = {};
                previews_data[data.result.pk] = {'sort_order': attr_obj.find(".existing_pp").find("li.ba_preview_form").length};
                _updateData(attr_obj, {previews: previews_data});
            },
            fail: function(e, data) {
                alert("{% trans "Error happened when uploading, please try later, or contact system admin." %}");
            }
        });

        attr_obj.find(".ba_texture_upload").fileupload({
            dataType: 'json',
            url: "{% url 'brand_attributes_view' %}",
            dropZone: attr_obj.find('.texture'),
            namespace: 'ba_texture',
            formData: {pk: _getFromData(attr_obj, "texture_pk")},
            add: function(e, data) {
                if (_validate_max_file_size(data.files[0])) {
                    _updateBackgroundImage(attr_obj.find(".ba_texture_btn"), "{{ STATIC_URL }}img/loading2.gif");
                    data.submit();
                }
            },
            done: function(e, data) {
                _updateBackgroundImage(attr_obj.find(".ba_texture_btn"), data.result.texture);
                _updateData(attr_obj, {ba_pk: -1, texture_pk: data.result.pk, type_pk: 'new'});
                attr_obj.find("input[id*=texture]").val(data.result.texture);

            }
        });

        attr_obj.find(".ba_input.autocomplete").autocomplete({
            autoFocus: true,
            source: "{% url 'brand_attributes_view' %}",
            min_length: 2,
            html: true,
            showTyping: true,
            focus: function(event, ui) {
                $(this).val(ui.item.name);
                return false;
            },
            select: function(e, ui) {
                if ($('#brand-attr-' + ui.item.value).length > 0) {
                    if ($('#brand-attr-' + ui.item.value + ':not(.removed)').length > 0) {
                        alert('{% trans "This product variant is already added." %}');
                        e.preventDefault();
                        return false;
                    } else {
                        alert('{% trans "This product variant was removed, will be activated." %}');
                        e.preventDefault();
                        active_removed_tab('#brand-attr-' + ui.item.value);
                        add_barcode_for_brand_attr(ui.item.value);
                        add_extref_for_brand_attr(ui.item.value);
                        return false;
                    }
                }

                _updateData(attr_obj,
                            {name: ui.item.name,
                             ba_pk: ui.item.value,
                             premium_type: ui.item.premium_type,
                             premium_amount: ui.item.premium_amount,
                             texture_pk: ui.item.value,
                             type_pk: 'exist'});
                $(this).val(ui.item.name);
                $(this).siblings("#premium_amount").val(ui.item.premium_amount);
                $(this).siblings("#premium_type").val(ui.item.premium_type);
                calcDiscount();
                $(this).focusout();
                _updateBackgroundImage(attr_obj.find(".ba_texture_btn"), ui.item.texture);
                return false;
            }
        });

        attr_obj.find('.add_ba').click(function(e) {
            var name = attr_obj.find(".ba_input").val();
            if (!name) {
                alert('{% trans "Attribute name can not be left blank." %}');
                e.preventDefault();
                return false;
            }
            var previews = [];
            attr_obj.find(".existing_pp li.ba_preview_form").each(function(){
                var pk = $(this).find("[id$=-pk]").val();
                var val = $(this).find("[id$=-sort_order]").val();
                previews.push({pk: pk, sort_order: val});
            });
            _updateData(attr_obj,
                        {name: name,
                         premium_type: attr_obj.find('select[id$=premium_type]').val(),
                         premium_amount: attr_obj.find('input[id$=premium_amount]').val(),
                         ba_pk: -1,
                         previews: JSON.stringify(previews),
                         ba_index: _getBaFormCount(),
                        });
            var data_send = attr_obj.data("ba_data");
            if (data_send.ba_pk == -1 && data_send.texture_pk != undefined) {
                data_send.pk = data_send.texture_pk;
            } else if (data_send.ba_pk != undefined) {
                data_send.pk = data_send.ba_pk;
            } else {
                data_send.pk = -1;
            }

            $.post("{% url 'brand_attributes_view' %}",
                data_send,
                function(data) {
                    if (data.success) {
                        new_tab($('.tabs'), 'brand-attr-' + data.pk,
                                data.name, data.ba_html);
                        var new_attr_obj = $('#brand-attr-' + data.pk);
                        ba_events(new_attr_obj);
                        add_barcode_for_brand_attr(data.pk, data.name, new_attr_obj);
                        add_extref_for_brand_attr(data.pk, data.name, new_attr_obj);

                        var obj = $('.tabs-header li:last').insertBefore($("li.add-attr"));
                        obj.find('a').click();

                        _addBaFormCount();
                        _clearBaForm(attr_obj); 
                    } else {
                        attr_obj.find('.ba_error').show().append("<li>" + data.err + "</li>");
                    }
                }
            );
        });

        attr_obj.find('select[id$=premium_type]').change(function(){
            var premium_type = $(this).val();
            if (premium_type == 'amount') {
                $(this).siblings(".premium_ratio_marker").hide();
                $(this).siblings(".premium_currency_marker").show();
            } else {
                $(this).siblings(".premium_ratio_marker").show();
                $(this).siblings(".premium_currency_marker").hide();
            }
            update_ba_premium($(this).parents('.brand_attributes-premium'));
        });
        attr_obj.find('select[id$=premium_type]').change();

        attr_obj.find('input[id$=premium_amount]').change(function(){
            update_ba_premium($(this).parents('.brand_attributes-premium'));
        });

    }
    $("div[id^=brand-attr-]").each(function(){
        var attr_obj = $(this);
        ba_events(attr_obj);
    });

    function render_premium_result(premium_price_node, premium_type, premium_amount){
        var selected_cur = $("#{{wizard.form.currency.auto_id}} option:selected").text();
        var normal_price = parseFloat($("#{{ wizard.form.normal_price.auto_id }}").val());
        premium_amount = parseFloat(premium_amount);
        premium_price_node.html('');
        if (normal_price) {
            $("<span>").html(_calc_premium_price(premium_type, premium_amount, normal_price))
                    .appendTo(premium_price_node);
            $("<span>").addClass("premium_currency_marker")
                    .html(selected_cur)
                    .appendTo(premium_price_node);
        } else {
            $("<span>").html('--').appendTo(premium_price_node);
        }
    };

    $(".remove_brand_attribute").live('click', function(){
        var ba = $(this).parents(".brand_attribute_form:first");
        ba.hide();
        var delete_input_id = "#id_"+ ba.attr('id').replace('-row', '-DELETE');
        $(delete_input_id).attr('checked', 'checked');
        return false;
    });


    /********************** Add New Brand ***********************/
    $("#add_new_brand_form").ajaxForm({
        //target: $("#{{ wizard.form.brand.auto_id }}"),
        success: function(responseText) {
            if(responseText.substring(0,5)=="ERROR")
            {
                $("#brand_new_error").html(responseText)
                $("#brand_new_error").show();
            }
            else
            {
                $("#{{ wizard.form.brand.auto_id }}").html(responseText)
                $("#brand_new_error").hide();
            }
            $("#add_new_brand_dialog").dialog("close");

        }
    });

    $("#add_new_brand").click(function(){
        $("#add_new_brand_dialog").dialog({
            modal: true,
            title: "{% trans "Add a new brand" %}",
            buttons: {
                "Cancel": function() {
                    $(this).dialog("close");
                }
            }
        });
        return false;
    });


    /********************** Discount ***********************/
    function _is_use_item_type_price() {
        return ($("span.normal_price_form:visible").length < 1 &&
                    $("span.type_attribute_price_form:visible").length > 0);
    }

    function _get_lowest_type_attribute_price() {
        var ta_prices = new Array();
        $("span.type_attribute_price_form:visible").each(function(){
            ta_prices.push(parseFloat($(this).find(".type_attribute_price").text()));
        });
        return ta_prices.length > 1 ? Math.min.apply(Math, ta_prices) : Math.min(ta_prices);
    }
    function _calc_discount_price(discount_type, discount, base_price) {
        if (discount_type == "percentage") { //percentage
            var tmp = base_price - (base_price * (discount / 100))
            return Math.round(tmp*100 +((tmp*1000%10>4)?1:0))/100;
        } else {
            return base_price - discount;
        }
    }
    function _calc_premium_price(premium_type, premium_amount, price) {
        if (premium_amount) {
            if (premium_type == "percentage") { //percentage
                var tmp = price + (price * (premium_amount / 100))
                return Math.round(tmp*100 +((tmp*1000%10>4)?1:0))/100;
            } else {
                return price + premium_amount;
            }
        } else {
            return price;
        }
    }
    function calcDiscount() {
        var use_item_type_price = _is_use_item_type_price();

        var discount = parseFloat($("#{{ wizard.form.discount.auto_id }}").val());
        if (isNaN(discount)) discount = 0;
        var discount_type = $("#{{ wizard.form.discount_type.auto_id }}").val();

        var discount_price_str_input = $("#{{ wizard.form.preview_discount_price_str.auto_id }}");
        var base_price_input = $("#{{ wizard.form.preview_base_price.auto_id }}");
        var discount_preview = $("#preview-{{ wizard.form.preview_discount_price_str.auto_id }}");
        var base_price_preview = $("#preview-{{ wizard.form.preview_base_price.auto_id }}");

        var selected_cur = $("#{{wizard.form.currency.auto_id}} option:selected").text();
        $("#discount_marker").html(discount_type == "percentage" ? "%": selected_cur);

        var premium_type = $("#premium_type").val();
        $("#premium_marker").html(premium_type == "percentage" ? "%": selected_cur);

        if (use_item_type_price) {
            var lowest_type_attribute_price = _get_lowest_type_attribute_price();
            var start_price = _calc_discount_price(discount_type, discount, lowest_type_attribute_price);

            // disable discount and premiums preview if there is no Unified price.
            $("span#result").hide();
            $("span#premium_result").hide();

            // preview start price on the right-preview.
            var display_discount_price = "{% trans "Starting at " %}"
                    + (start_price > 0 ? start_price : lowest_type_attribute_price);
            base_price_input.val(lowest_type_attribute_price);
            base_price_preview.html(lowest_type_attribute_price + selected_cur);
            discount_price_str_input.val(display_discount_price);
            discount_preview.html(display_discount_price + selected_cur);
        } else {
            var normal_price = parseFloat($("#{{ wizard.form.normal_price.auto_id }}").val());
            var new_price = _calc_discount_price(discount_type, discount, normal_price);
            var premium_amount = parseFloat($("#premium_amount").val());
            var premium_price = _calc_premium_price(premium_type, premium_amount, new_price);

            $("span#result").show();
            $("span#premium_result").show();

            var display_price = new_price > 0 ? new_price : normal_price;
            if (isNaN(normal_price)) normal_price = "{% trans "N/A" %}";
            if (isNaN(display_price)) display_price = "{% trans "N/A" %}";
            $("#discount_price").html(display_price);
            base_price_input.val(normal_price);
            base_price_preview.html(normal_price + "&nbsp;" + selected_cur);
            discount_price_str_input.val(display_price);
            discount_preview.html(display_price + "&nbsp;" + selected_cur);

            if (premium_price > 0) {
                $("#premium_price_val").val(parseFloat(premium_price));
                $("#premium_price").html(parseFloat(premium_price));
            } else {
                if (new_price > 0) {
                    $("#premium_price_val").val(parseFloat(new_price));
                    $("#premium_price").html(new_price);
                }
                else {
                    $("#premium_price_val").val("");
                    $("#premium_price").html("{% trans "N/A" %}");
                }
            }
        }
    }

    $("#{{ wizard.form.discount_type.auto_id }}").change(function(){
        calcDiscount();
    });
    $("#{{ wizard.form.normal_price.auto_id }}").change(function(elmt){
        calcDiscount();
    });
    $("#{{ wizard.form.discount.auto_id }}").change(function(elmt){
        calcDiscount();
    });
    $("#premium_type").change(function(){
        calcDiscount();
    });
    $("#premium_amount").change(function(){
        calcDiscount();
    });


    /********************** Update Product Preveiw ***********************/
    function update_ba_premium(obj) {
        var premium_type = obj.find("select[id$=premium_type]").val();
        var premium_amount = obj.find("input[id$=premium_amount]").val() || 0;
        var result_node = obj.parent().next().find('.brand_attributes-premium-result');
        render_premium_result(result_node, premium_type, premium_amount);
    }
    function update_all_ba_premium() {
        $('.brand_attributes-premium').each(function (){
            update_ba_premium($(this));
        });
    }

    /********************** Type Attribute Price ***********************/
    $("#add_tap").click(function(e) {
        // blank price
        var ta_price = $("#type_attribute_price_input").val();
        if (!ta_price) {
            alert("{% trans "The price can not be left blank." %}");
            e.preventDefault();
            return false;
        }

        var select_ta = $("#type_attribute_selector").val();
        var select_ta_name = $("#type_attribute_selector option:selected").text();
        var select_cur = $("#{{wizard.form.currency.auto_id}} option:selected").text();


        // NORMAL PRICE
        if (select_ta == 0) {
            // Normal price has been added.
            if ($("#type_attribute_prices span.normal_price_price").length > 0) {
                alert("The {% trans "Unified price" %} has been added!");
                return false;
            }

            // Add normal price, fill input values and display
            $("<span>").addClass("normal_price_form")
                       .append($("#normal_price_template_form").html())
                       .appendTo($("#type_attribute_prices"));
            $("#{{ wizard.form.normal_price.auto_id }}").val(ta_price).change();
            $("#type_attribute_prices span.normal_price_price").text(ta_price);
            $("#type_attribute_prices span.normal_price_currency").text(select_cur);
            update_all_ba_premium();

            add_barcode_for_common_attr("", $("#{{ wizard.form.name.auto_id }}").val());
            add_extref_for_common_attr("", $("#{{ wizard.form.name.auto_id }}").val());
            return false;
        }


        // TYPE ATTRIBUTE PRICE
        {% with wizard.form.type_attribute_prices.empty_form as tap_empty %}
        // this type attribute price has been added.
        if ($("#type_attribute_prices span.type_attribute_price_form:visible span.type_attribute_value[data-value="+select_ta+"]").length > 0) {
            alert("The price of \"" + select_ta_name + "\" has been added!");
            return false;
        }
        // add type attribute price
        var nb_of_forms = $("#{{ wizard.form.type_attribute_prices.management_form.TOTAL_FORMS.auto_id }}").val();
        var nb_of_forms_str = nb_of_forms.toString();
        var form = $("#type_attribute_price_template_form").html();
        form = replace_form_prefix(form, nb_of_forms_str);

        var tap_id_input = replace_form_prefix("#{{ tap_empty.tap_id.auto_id }}", nb_of_forms_str);
        var type_attribute_input = replace_form_prefix("#{{ tap_empty.type_attribute.auto_id }}", nb_of_forms_str);
        var type_attribute_price_input = replace_form_prefix("#{{ tap_empty.type_attribute_price.auto_id }}", nb_of_forms_str);
        var ta_span = replace_form_prefix("#{{ tap_empty.prefix }}-type_attribute", nb_of_forms_str);
        var ta_name_span = replace_form_prefix("#{{ tap_empty.prefix }}-type_attribute_name", nb_of_forms_str);
        var tap_span = replace_form_prefix("#{{ tap_empty.prefix }}-type_attribute_price", nb_of_forms_str);
        var tapc_span = replace_form_prefix("#{{ tap_empty.prefix }}-type_attribute_price_cur", nb_of_forms);
        {% endwith %}

        $("#type_attribute_prices").append(form);
        $(tap_id_input).val(-1);
        $(type_attribute_input).val(select_ta);
        $(type_attribute_price_input).val(ta_price);
        $(ta_span).text(select_ta);
        $(ta_span).attr("data-value", select_ta);
        $(ta_name_span).text(select_ta_name);
        $(tap_span).text(ta_price);
        $(tapc_span).text(select_cur);

        nb_of_forms++;
        $("#{{ wizard.form.type_attribute_prices.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);

        // Remove normal price option and input
        $("#type_attribute_selector option[value=0]").remove();
        $("span.normal_price_form").remove();
        $("#{{ wizard.form.normal_price.auto_id }}").val("").change();
        update_all_ba_premium();

        add_barcode_for_common_attr(select_ta, select_ta_name);
        add_extref_for_common_attr(select_ta, select_ta_name);
        return false;
    });

    $("span.remove_type_attribute_price").live("click", function(){
        $(this).siblings("input:checkbox[id*=DELETE]").prop("checked", true);
        $(this).parent().hide();
        // Reappear normal price option
        if ($("span.type_attribute_price_form:visible").length < 1 &&
                $("#type_attribute_selector option[value=0]").length < 1) {
            $("#type_attribute_selector").prepend($("<option>", {value: 0, text: "{% trans "Unified price" %}"}));
        }
        calcDiscount();
        var attr_id = $(this).siblings('.type_attribute_value').text();
        remove_barcode_for_common_attr(attr_id);
        remove_extref_for_common_attr(attr_id);
    });
    $("span.remove_normal_price").live("click", function(){
        $("#{{ wizard.form.normal_price.auto_id }}").val("").change();
        $(this).parent().remove();
        remove_barcode_for_common_attr("");
        remove_extref_for_common_attr("");
    });


    /********************** Type Attribute Weight ***********************/
    $("#add_taw").click(function(e) {
        // blank weight
        var ta_weight = $("#type_attribute_weight_input").val();
        if (!ta_weight) {
            alert("{% trans "The weight can not be left blank." %}");
            e.preventDefault();
            return false;
        }

        var select_ta = $("#type_attribute_weight_selector").val();
        var select_ta_name = $("#type_attribute_weight_selector option:selected").text();
        var select_wu = $("#{{wizard.form.weight_unit.auto_id}} option:selected").text();

        // Standard Weight
        if (select_ta == 0) {
            // Standard weight has been added.
            if ($("#type_attribute_weights span.standard_weight").length > 0) {
                alert("The {% trans "Standard Weight" %} has been added!");
                return false;
            }

            // Add standard weight, fill input values and display
            $("<span>").addClass("standard_weight_form")
                    .append($("#standard_weight_template_form").html())
                    .appendTo($("#type_attribute_weights"));
            $("#{{ wizard.form.standard_weight.auto_id }}").val(ta_weight).change();
            $("#type_attribute_weights span.standard_weight").text(ta_weight);
            $("#type_attribute_weights span.standard_weight_unit").text(select_wu);
            return false;
        }

        // TYPE ATTRIBUTE WEIGHT
        {% with wizard.form.type_attribute_weights.empty_form as taw_empty %}
            // this type attribute weight has been added.
            if ($("#type_attribute_weights span.type_attribute_weight_form:visible span.type_attribute_value[data-value="+select_ta+"]").length > 0) {
                alert("The weight of \"" + select_ta_name + "\" has been added!");
                return false;
            }
            // add type attribute weight
            var nb_of_forms = $("#{{ wizard.form.type_attribute_weights.management_form.TOTAL_FORMS.auto_id }}").val();
            var nb_of_forms_str = nb_of_forms.toString();
            var form = $("#type_attribute_weight_template_form").html();
            form = replace_form_prefix(form, nb_of_forms_str);

            var taw_id_input = replace_form_prefix("#{{ taw_empty.taw_id.auto_id }}", nb_of_forms_str);
            var type_attribute_input = replace_form_prefix("#{{ taw_empty.type_attribute.auto_id }}", nb_of_forms_str);
            var type_attribute_weight_input = replace_form_prefix("#{{ taw_empty.type_attribute_weight.auto_id }}", nb_of_forms_str);
            var ta_span = replace_form_prefix("#{{ taw_empty.prefix }}-type_attribute", nb_of_forms_str);
            var ta_name_span = replace_form_prefix("#{{ taw_empty.prefix }}-type_attribute_name", nb_of_forms_str);
            var taw_span = replace_form_prefix("#{{ taw_empty.prefix }}-type_attribute_weight", nb_of_forms_str);
            var tawu_span = replace_form_prefix("#{{ taw_empty.prefix }}-type_attribute_weight_unit", nb_of_forms);
        {% endwith %}

        $("#type_attribute_weights").append(form);
        $(taw_id_input).val(-1);
        $(type_attribute_input).val(select_ta);
        $(type_attribute_weight_input).val(ta_weight);
        $(ta_span).attr("data-value", select_ta);
        $(ta_name_span).text(select_ta_name);
        $(taw_span).text(ta_weight);
        $(tawu_span).text(select_wu);

        nb_of_forms++;
        $("#{{ wizard.form.type_attribute_weights.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);

        // Remove standard weight option and input
        $("#type_attribute_weight_selector option[value=0]").remove();
        $("span.standard_weight_form").remove();
        $("#{{ wizard.form.standard_weight.auto_id }}").val("").change();

        return false;
    });

    $("span.remove_type_attribute_weight").live("click", function(){
        $(this).siblings("input:checkbox[id*=DELETE]").prop("checked", true);
        $(this).parent().hide();
        // Reappear standard weight option
        if ($("span.type_attribute_weight_form:visible").length < 1 &&
                $("#type_attribute_weight_selector option[value=0]").length < 1) {
            $("#type_attribute_weight_selector").prepend($("<option>", {value: 0, text: "{% trans "Standard Weight" %}"}));
        }
    });
    $("span.remove_standard_weight").live("click", function(){
        $("#{{ wizard.form.standard_weight.auto_id }}").val("").change();
        $(this).parent().remove();
    });

    {# weight unit dropdown change event#}
    function weight_unit_changed() {
        var selected_cur = $("#{{wizard.form.weight_unit.auto_id}} option:selected").text();
        $("#taw_weight_unit").html(selected_cur);
        $("#type_attribute_weights span.standard_weight_unit").text(selected_cur);
        $(".type_attribute_weight_unit").each(function(){
            $(this).text(selected_cur);
        });
    }
    $("#{{wizard.form.weight_unit.auto_id}}").change(function(e){
        weight_unit_changed();
    });

    /********************** Utils ***********************/
    String.prototype.replaceAll = function(reallyDo, replaceWith, ignoreCase) {  
        if (!RegExp.prototype.isPrototypeOf(reallyDo)) {  
            return this.replace(new RegExp(reallyDo, (ignoreCase ? "gi": "g")), replaceWith);  
        } else {  
            return this.replace(reallyDo, replaceWith);  
        }  
    }

    // Get product types by selected product category
    function getTypeOptions(cat_id) {
        if (cat_id) {
            $.ajax({
                type: "GET",
                url: "/sales/get_product_types/" + cat_id,
                dataType:"json",
                success: function(data, textStatus){
                    $("#product_type_selector").empty();
                    $.each(data, function(i, option){
                        if (option.valid) {
                            $("#product_type_selector").append($("<option>", {value: option.value, text: option.label}));
                        } else if ("{{ wizard.form.type.value }}" != "None" && option.value == {{ wizard.form.type.value }}) {
                            $("#product_type_selector").append($("<option>", {value: option.value, text: "({% trans "invalid" %})" + option.label}));
                        }
                    });
                    if ("{{ wizard.form.type.value }}") {
                        $("#product_type_selector").val("{{ wizard.form.type.value }}").change();
                    }
                    set_default_option($('#product_type_selector'));
                }
            });
        } else {
            $("#product_type_selector").empty();
        }
        $("#product_type_selector").change();
    }

    // Get item type attributes by selected product type
    function getItemTypeAttributeOptions(type_id) {
        $("#{{ wizard.form.type.auto_id }}").val(type_id);
        if (type_id) {
            $.ajax({
                type: "GET",
                url: "/attributes/get_item_attrs/" + type_id,
                dataType:"json",
                success: function(data, textStatus){
                    // initialise Price selector
                    $("#type_attribute_selector").empty();
                    if ($("span.type_attribute_price_form:visible").length < 1 &&
                            $("#type_attribute_selector option[value=0]").length < 1) {
                        $("#type_attribute_selector").prepend($("<option>", {value: 0, text: "{% trans "Unified price" %}"}));
                    }
                    $.each(data, function(i, option){
                        if (option.valid) {
                            $("#type_attribute_selector").append($("<option>", {value: option.value, text: option.label}));
                        }
                        add_barcode_for_common_attr(option.value, option.label);
                        add_extref_for_common_attr(option.value, option.label);
                    });

                    // initialise weight selector
                    $("#type_attribute_weight_selector").empty();
                    if ($("span.type_attribute_weight_form:visible").length < 1 &&
                            $("#type_attribute_weight_selector option[value=0]").length < 1) {
                        $("#type_attribute_weight_selector").prepend($("<option>", {value: 0, text: "{% trans "Standard Weight" %}"}));
                    }
                    $.each(data, function(i, option){
                        if (option.valid) {
                            $("#type_attribute_weight_selector").append($("<option>", {value: option.value, text: option.label}));
                        }
                    });

                }
            });
        } else {
            $("#type_attribute_selector").empty();
            $("#type_attribute_selector").append($("<option>", {value: 0, text: "{% trans "Unified price" %}"}));
            $("#type_attribute_weight_selector").empty();
            $("#type_attribute_weight_selector").append($("<option>", {value: 0, text: "{% trans "Standard Weight" %}"}));
        }
    }

    function _get_datepicker_locale(s) {
        var l = s.split('-');
        if (l[0] == 'en') return '';
        if (l[1]) l[1] = l[1].toUpperCase();
        l = l.join('_');
        return l;
    }

    function prod_name_changed() {
        var prod_name = $("#{{ wizard.form.name.auto_id }}").val();
        if (prod_name == '') {
            $('.tabs li.base-item a').text('{% trans "Product name" %}');
        } else {
            $('.tabs li.base-item a').text(prod_name);
        }
        $('#base-item .title').text(prod_name);
    }
    $("#{{ wizard.form.name.auto_id }}").change(function(e){
        prod_name_changed();
    });

    {# currency dropdown change event#}
    function currency_changed() {
        var selected_cur = $("#{{wizard.form.currency.auto_id}} option:selected").text();
        $("#id_discount_price_marker").html(selected_cur);
        $("#id_premium_price_marker").html(selected_cur);
        $("#tap_currency").html(selected_cur);
        $("#type_attribute_prices span.normal_price_currency").text(selected_cur);
        $(".type_attribute_price_currency").each(function(){
            $(this).text(selected_cur);
        });
        $(".premium_currency_marker").each(function(){
            $(this).text(selected_cur);
        });
        calcDiscount();
    }
    $("#{{wizard.form.currency.auto_id}}").change(function(e){
        currency_changed();
    });

    function replace_form_prefix(str1, str2) {
        return str1.replace(/__prefix__/g, str2);
    }

    // Those will be called when page is reloaded, for example if data validation
    // fails or we clicked "prev" from next step
    calcDiscount();
    $("#{{ wizard.form.brand.auto_id }}").change();
    if ("{{ wizard.form.category.value }}") {
        $("#{{ wizard.form.category.auto_id }}").change();
    }
    $("#{{ wizard.form.valid_from.auto_id }}").datepicker();
    $("#{{ wizard.form.valid_to.auto_id }}").datepicker({
        onSelect: function(dateText, inst) {
            $("#preview-{{ wizard.form.valid_to.auto_id }}").html(dateText).parents("span:first").show();
        }
    });

    /********************** Gallery ***********************/
    function render_gallery_row(name, imgs) {
        var index = $('#gallery table tr').length + 1;
        var _html = '<th>' + index + '</th>' + 
                    '<td><div><h1></h1><ul></ul></div></td>';
        var row = $('<tr>').html(_html);
        row.find('h1').text(name);
        for (var idx in imgs) {
            row.find('ul').append($('<li><img orig_id="' + imgs[idx]['id']  + '" src="' + imgs[idx]['src'] + '"/></li>'));
        }
        return row
    }
    function render_gallery() {
        var table = $('#gallery table');
        table.html('');
        
        var prod_name = $("#{{ wizard.form.name.auto_id }}").val() || '';
        var prod_imgs = [];
        $("#existing_pp img").each(function(){
            var del_node = $(this).parent().siblings('input:checkbox[id*=DELETE]')
            if (del_node.attr("checked") != 'checked') {
                var _id = $(this).attr('id');
                var _src = $(this).attr('src');
                prod_imgs.push({id: _id, src: _src})
            }
        });
        $(render_gallery_row(prod_name, prod_imgs)).appendTo(table);

        $("li.brand-attr:visible").each(function(){
            var tab_id = $(this).find('a').attr('href');
            var attr_name = $(this).find('a').text();
            var attr_imgs = [];
            $(tab_id + " .existing_pp img").each(function(){
                var del_node = $(this).parent().siblings('input:checkbox[id*=DELETE]')
                if (del_node.attr("checked") != 'checked') {
                    var _id = $(this).attr('id');
                    var _src = $(this).attr('src');
                    attr_imgs.push({id: _id, src: _src})
                }
            });
            $(render_gallery_row(attr_name, attr_imgs)).appendTo(table);
        });

        table.find('ul').each(function(){
            $(this).sortable();
        });
    }
    function save_gallery() {
        var table = $('#gallery table');
        table.find('ul').each(function(){
            $(this).find('img').each(function(img_idx){
                var img_row_id = $(this).attr('orig_id').replace('-img', '-row'); 
                $('#' + img_row_id).find('[id$=-sort_order]').val(img_idx);
            });
        });
    }
    function sort_existing_pp(ul_obj) {
        var li_objs = ul_obj.find('li');
        var i = 0;
        for (i=0; i< li_objs.length; i++) {
            var li = li_objs.find('[id$=-sort_order][value=' + i + ']').parents('li');
            ul_obj.append(li);
            li.insertBefore(li_objs.last());
        }
    }

    /********************** Tabs ***********************/
    function new_tab(tabs, tabId, tabLabel, tabContentHtml) {
         var header = "<li class='brand-attr'><span class='delete'>Delete</span><a href='#" + tabId + "'>" + tabLabel + "</a> </li>";
         tabs.find(".ui-tabs-nav").append(header);
         tabs.append("<div id='" + tabId + "' class='visuelProd'>" + tabContentHtml + "</div>");
         tabs.tabs("refresh");
    }

    $(".tabs").on('tabsactivate', function(event, ui) {
        var index = ui.newTab.index();
        if (index === $('.tabs >ul >li').length - 1) {
            // last tab
            render_gallery();
        } else {
            save_gallery();
            if (index == 0) {
                sort_existing_pp($('#existing_pp'));
            } else {
                var attr_id = ui.newTab.find('a').attr('href');
                if (attr_id != '#brand-attr-0')
                    sort_existing_pp($(attr_id + ' .existing_pp'));
            }
        }
    });

    $(document).on("click", "ul.tabs-header li.brand-attr .delete", function(){
        var tab_id = $(this).siblings('a').attr('href');
        $(this).parents('.brand-attr').hide();
        $(tab_id).addClass('removed').hide();
        $(tab_id).find("input:checkbox[id*=DELETE]:first").attr("checked", "checked");
        $('.tabs-header li.base-item a').click();

        remove_barcode_for_brand_attr(tab_id.replace('#brand-attr-', ''));
        remove_extref_for_brand_attr(tab_id.replace('#brand-attr-', ''));
    });

    function active_removed_tab(tab_id) {
        $(tab_id).removeClass('removed').show();
        $(tab_id).find("input:checkbox[id*=DELETE]:first").removeAttr("checked");
        $('.brand-attr a[href="' + tab_id + '"]').parents('.brand-attr').show();
        $('.brand-attr a[href="' + tab_id + '"]').click();
    }

    /********************** Upload files ***********************/
    $(document).on("click", "a.uploadfile",function(){
        $(this).siblings('input[type=file]').click();
    });
    $(document).on("click", ".visuelProd ul li span .delete",function(){
        $(this).parents('li').hide(); 
        $(this).parents('li').find('input:checkbox[id*=DELETE]').attr("checked", "checked");
    });

    /********************** Barcode ***********************/
    function update_barcodes() {
        var ca_ids = _get_ca_ids();
        _update_barcode_display($('#base-item'), ca_ids);
        _update_barcode_display($('[id^=brand-attr-]'), ca_ids);
        _update_barcodes_delete();
    }
    function _get_ca_ids() {
        var ca_ids = [];
        if (_is_use_item_type_price()) {
            $('.type_attribute_price_form:visible .type_attribute_value').each(function() {
                ca_ids.push($(this).text());
            });
        } else {
            $('#type_attribute_selector option').each(function() {
                if ($(this).val() != "0")
                    ca_ids.push($(this).val());
            });
        }
        return ca_ids;
    }
    function _update_barcode_display(show_tabs, ca_ids) {
        show_tabs.find('.barcodes-item').each(function() {
            if (ca_ids.length > 0 && ca_ids.indexOf($(this).attr('data-ca')) == -1)
                $(this).hide();
            else
                $(this).show();
        });
        show_tabs.find('.barcodes-block').show();
    }
    function _update_barcodes_delete() {
        $('.barcodes-block .barcodes-item').each(function(){
            var node = $(this);
            if (node.css('display') == 'none'
                    || node.parents('.barcodes-ba').css('display') == 'none'
                    || node.parents('.barcodes-block').css('display') == 'none')
                node.find("input:checkbox[id$=DELETE]").attr("checked", "checked");
            else
                node.find("input:checkbox[id$=DELETE]").removeAttr("checked");
        });
    }

    function add_barcode_for_brand_attr(attr_id, attr_name, attr_obj) {
        if ($('.barcodes-ba[data-ba="' + attr_id + '"]').length > 0) {
            $('.barcodes-ba[data-ba="' + attr_id + '"]').show();
        } else {
            var nb_of_forms = $("#{{ wizard.form.barcodes.management_form.TOTAL_FORMS.auto_id }}").val();
            $('#brand-attr-0 .barcodes-ba').each(function() {
                var newba = $(this).clone();
                newba.attr('data-ba', attr_id);
                newba.appendTo(attr_obj.find('.barcodes-block'));
                newba.show();

                newba.find('.barcodes-item').each(function() {
                    var node = $(this);
                    var old_prefix = node.find("input[name*=-upc]").attr('name').replace('-upc', '');
                    var new_prefix = 'barcodes-' + nb_of_forms;
                    var value = node.find("input[id$=-upc]").val();
                    node.html(node.html().replaceAll(old_prefix, new_prefix));
                    node.find("input[id$=-upc]").val(value);
                    node.find("input[id$=brand_attribute]").val(attr_id);
                    node.find("input[id$=brand_attribute]").attr('value', attr_id);

                    nb_of_forms++;
                    $("#{{ wizard.form.barcodes.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);
                });
            });
        }
        update_barcodes();
    }
    function remove_barcode_for_brand_attr(attr_id) {
        $('.barcodes-ba[data-ba="' + attr_id + '"]').hide();
        update_barcodes();
    }
    function add_barcode_for_common_attr(attr_id, attr_name) {
        if (attr_id && $('.barcodes-item[data-ca=""]').length > 0) {
            $('.barcodes-item[data-ca=""]').hide();
        }
        if ($('.barcodes-item[data-ca="' + attr_id + '"]').length > 0) {
            $('.barcodes-item[data-ca="' + attr_id + '"]').show();
        } else {
            var nb_of_forms = $("#{{ wizard.form.barcodes.management_form.TOTAL_FORMS.auto_id }}").val();
            $('.barcodes-ba').find('.barcodes-item:last').each(function() {
                var newnode = $(this).clone();
                var old_prefix = newnode.find("input[name*=-upc]").attr('name').replace('-upc', '');
                var new_prefix = 'barcodes-' + nb_of_forms;
                newnode.html(newnode.html().replaceAll(old_prefix, new_prefix));
                newnode.find('label').text(attr_name);
                newnode.find("input[id$=-upc]").val('');
                newnode.find("input[id$=common_attribute]").val(attr_id);
                newnode.find("input[id$=common_attribute]").attr('value', attr_id);
                newnode.insertAfter($(this));
                newnode.show();
                newnode.attr('data-ca', attr_id);

                nb_of_forms++;
                $("#{{ wizard.form.barcodes.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);
            });
        }
        update_barcodes();
    }
    function remove_barcode_for_common_attr(attr_id) {
        $('.barcodes-item[data-ca="' + attr_id + '"]').hide();
        update_barcodes();
    }

    /********************** External Ref ***********************/
    function update_extrefs() {
        var ca_ids = _get_ca_ids();
        _update_extrefs_display($('#base-item'), ca_ids)
        _update_extrefs_display($('[id^=brand-attr-]'), ca_ids)
        _update_extrefs_delete();
    }
    function _update_extrefs_display(show_tabs, ca_ids) {
        show_tabs.find('.extrefs-item').each(function() {
            if (ca_ids.length > 0 && ca_ids.indexOf($(this).attr('data-ca')) == -1)
                $(this).hide();
            else
                $(this).show();
        });
        show_tabs.find('.extrefs-block').show();
    }
    function _update_extrefs_delete() {
        $('.extrefs-block .extrefs-item').each(function(){
            var node = $(this);
            if (node.css('display') == 'none'
                    || node.parents('.extrefs-ba').css('display') == 'none'
                    || node.parents('.extrefs-block').css('display') == 'none')
                node.find("input:checkbox[id$=DELETE]").attr("checked", "checked");
            else
                node.find("input:checkbox[id$=DELETE]").removeAttr("checked");
        });
    }

    function add_extref_for_brand_attr(attr_id, attr_name, attr_obj) {
        if ($('.extrefs-ba[data-ba="' + attr_id + '"]').length > 0) {
            $('.extrefs-ba[data-ba="' + attr_id + '"]').show();
        } else {
            var nb_of_forms = $("#{{ wizard.form.externalrefs.management_form.TOTAL_FORMS.auto_id }}").val();
            $('#brand-attr-0 .extrefs-ba').each(function() {
                var newba = $(this).clone();
                newba.attr('data-ba', attr_id);
                newba.appendTo(attr_obj.find('.extrefs-block'));
                newba.show();

                newba.find('.extrefs-item').each(function() {
                    var node = $(this);
                    var old_prefix = node.find("input[name*=-external_id]").attr('name').replace('-external_id', '');
                    var new_prefix = 'extrefs-' + nb_of_forms;
                    var value = node.find("input[id$=-external_id]").val();
                    node.html(node.html().replaceAll(old_prefix, new_prefix));
                    node.find("input[id$=-external_id]").val(value);
                    node.find("input[id$=brand_attribute]").val(attr_id);
                    node.find("input[id$=brand_attribute]").attr('value', attr_id);

                    nb_of_forms++;
                    $("#{{ wizard.form.externalrefs.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);
                });
            });
        }
        update_extrefs();
    }
    function remove_extref_for_brand_attr(attr_id) {
        $('.extrefs-ba[data-ba="' + attr_id + '"]').hide();
        update_extrefs();
    }
    function add_extref_for_common_attr(attr_id, attr_name) {
        if (attr_id && $('.extrefs-item[data-ca=""]').length > 0) {
            $('.extrefs-item[data-ca=""]').hide();
            var nodes = $('.extrefs-item[data-ca=""]:hidden');
            nodes.find("input:checkbox[id*=DELETE]").attr("checked", "checked");
        }
        if ($('.extrefs-item[data-ca="' + attr_id + '"]').length > 0) {
            $('.extrefs-item[data-ca="' + attr_id + '"]').show();
            var nodes = $('.extrefs-item[data-ca="' + attr_id + '"]:visible');
            nodes.find("input:checkbox[id*=DELETE]").removeAttr("checked");
        } else {
            var nb_of_forms = $("#{{ wizard.form.externalrefs.management_form.TOTAL_FORMS.auto_id }}").val();
            $('.extrefs-ba').find('.extrefs-item:last').each(function() {
                var newnode = $(this).clone();
                var old_prefix = newnode.find("input[name*=-external_id]").attr('name').replace('-external_id', '');
                var new_prefix = 'extrefs-' + nb_of_forms;
                newnode.html(newnode.html().replaceAll(old_prefix, new_prefix));
                newnode.find('label').text(attr_name);
                newnode.find("input[id$=-external_id]").val('');
                newnode.find("input[id$=common_attribute]").val(attr_id);
                newnode.find("input[id$=common_attribute]").attr('value', attr_id);
                newnode.insertAfter($(this));
                newnode.show();
                newnode.attr('data-ca', attr_id);

                nb_of_forms++;
                $("#{{ wizard.form.externalrefs.management_form.TOTAL_FORMS.auto_id }}").val(nb_of_forms);
            });
        }
        update_extrefs();
    }
    function remove_extref_for_common_attr(attr_id) {
        $('.extrefs-item[data-ca="' + attr_id + '"]').hide();
        update_extrefs();
    }
</script>
{% endblock %}
