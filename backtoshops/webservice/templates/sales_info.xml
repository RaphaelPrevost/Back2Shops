{% load get_preview %}
{% load l10n %}

<info type="sale" version="1.0">
<sale id="{{ object.pk }}">
    <!-- item category -->
    <category id="{{ object.product.category.pk }}" name="{{ object.product.category.name }}" />
    
    <!-- item type -->
    <type id="{{ object.product.type.pk }}">
        <name>{{ object.product.type.name }}</name>
        {% for ca in object.product.type.common_attributes.all %}
        <attribute id="{{ca.pk}}" name="{{ca.name}}" />
        {% endfor %}
    </type>
    
    <!-- basic information -->
    <name>{{ object.product.name }}</name>
    <desc>{{ object.product.description }}</desc>
    {% for pic in object.product.pictures.all %}
    <img>{{ pic.picture.url }}</img>
    {% endfor %}
    
    <!-- brand responsible for sale-->
    <brand id="{{ object.mother_brand.pk }}" id_address="{{ object.mother_brand.address.id }}">
        <name>{{ object.mother_brand.name }}</name>
        <img>{% if object.mother_brand.logo %}{{ object.mother_brand.logo.url }}{% endif %}</img>
    </brand>

    <!-- weight unit -->
    <weight_unit>{{object.product.weight_unit_id}}</weight_unit>

    <!-- sale's weight -->
    {% if object.product.standard_weight %}
        <standard_weight>
            {{ object.product.standard_weight|floatformat }}
        </standard_weight>
    {% else %}
        {% for tap in object.typeattributeweight_set.all %}
            <type_weight id="{{ tap.type_attribute.id }}">
                <name>{{ tap.type_attribute.name }}</name>
                <weight>{{ tap.type_attribute_weight|floatformat }}</weight>
            </type_weight>
        {% endfor %}
    {% endif %}

    <!-- default price -->
    <price currency="{{object.product.currency}}">{{ object.product.normal_price|floatformat }}</price>

    <!-- type attribute prices -->
    {% for tap in object.typeattributeprice_set.all %}
    <price currency="{{ object.product.currency }}" attribute="{{ tap.type_attribute.id }}">
    {{ tap.type_attribute_price }}
    </price>
    {% endfor %}

    <!-- discount (type: "ratio" or "fixed" ) if it has -->
    {% if object.product.discount %}
    <discount type="{% if object.product.discount_type == 'percentage' %}ratio{% else %}fixed{% endif %}">{{ object.product.discount|floatformat }}</discount>
    {% endif %}

    <!-- if there is some variants for this product, list them here -->
    {% for variant in object.product.brand_attributes.all %}
        {% with preview=variant|get_preview:object.product %}
        <variant id="{{ variant.pk }}">
            <name>{{ variant.name }}</name>
            <thumb>{% if variant.texture %}{{ variant.texture.url }}{% endif %}</thumb>
            <img>{{ preview.preview.picture.url }}</img>
            <premium type="{% if variant.premium_type == 'percentage' %}ratio{% else %}fixed{% endif %}">{% firstof variant.premium_amount "0" %}</premium>
        </variant>
        {% endwith %}
    {% endfor %}
    <!-- end of the optional variants list -->

    <!-- list of shops where the product is available (country=2 letters ISO code) -->
    {% for shop in object.shops.all %}
    <shop id="{{ shop.pk }}" id_address="{{ shop.address.id }}">
        <name>{{ shop.name }}</name>
        <desc>{{ shop.description }}</desc>
        <caption>{{ shop.catcher }}</caption>
        <img>{% if shop.logo %}{{ shop.logo.url }}{% endif %}</img>
        <addr>{{ shop.address.address }}</addr>
        <zip>{{ shop.address.zipcode }}</zip>
        <city>{{ shop.address.city }}</city>
        <province_code>{{ shop.address.province_code }}</province_code>
        <country>{{ shop.address.country.iso }}</country>
        <upc>{{ shop.upc }}</upc>
        <location lat="{{ shop.latitude|unlocalize }}" long="{{ shop.longitude|unlocalize }}" />
        <hours>{{ shop.opening_hours }}</hours>
    </shop>
    {% endfor %}
    <!-- end of shops list -->

    <available from="{{ object.product.valid_from|date:"c" }}"
            {% if object.product.valid_to %}
               to="{{ object.product.valid_to|date:"c" }}"
            {% endif %}
            >
    {% for ba in object.product.brand_attributes.all %}
        {% for ca in object.product.type.common_attributes.all %}
        <stocks variant="{{ ba.pk }}" attribute="{{ ca.pk }}">
            {% for barcode in object.barcodes.all %}
                {% if barcode.brand_attribute == ba and barcode.common_attribute == ca %}
                <upc>{% if barcode.upc %}{{ barcode.upc }}{% endif %}</upc>
                {% endif %}
            {% endfor %}
            {% for stock in object.detailed_stock.all %}
                {% if stock.brand_attribute == ba and stock.common_attribute == ca %}
                <stock shop="{% if stock.shop %}{{ stock.shop.pk }}{% endif %}" available="{{ stock.rest_stock }}" />
                {% endif %}
            {% endfor %}
        </stocks>
        {% endfor %}
    {% empty %}
        {% for ca in object.product.type.common_attributes.all %}
            <stocks variant="" attribute="{{ ca.pk }}">
                {% for barcode in object.barcodes.all %}
                    {% if barcode.common_attribute == ca %}
                    <upc>{% if barcode.upc %}{{ barcode.upc }}{% endif %}</upc>
                    {% endif %}
                {% endfor %}
                {% for stock in object.detailed_stock.all %}
                    {% if stock.common_attribute == ca %}
                    <stock shop="{% if stock.shop %}{{ stock.shop.pk }}{% endif %}" available="{{ stock.rest_stock }}" />
                    {% endif %}
                {% endfor %}
            </stocks>
        {% endfor %}
    {% endfor %}
    </available>
</sale>
</info>
