{% load i18n %}

<!--ENSEMBLE EN DETAIL-->
<div class="packing">
    <h3>{% trans "Order" %}#{{ packing.order_id }}</h3>
    <em>
        {% if packing.deadline %}
            {{ packing.deadline }}
        {% endif %}
    </em>
    {% for shipment in packing.shipments %}
        <div class="shipment" id="shipment_{{ shipment.id }}">
            {% include "_shipment_packing.html" %}
        </div>
    {% endfor %}
</div>

<script type="text/javascript">
jQuery(
        //JQuery的日历控件汉化
        function($){
            $.datepicker.regional['zh_CN'] = {
                clearText: '清除',

                clearStatus: '清除已选日期',
                closeText: '关闭',

                closeStatus: '不改变当前选择',
                prevText: '&lt;上月',

                prevStatus: '显示上月',
                nextText: '下月&gt;',

                nextStatus: '显示下月',
                currentText: '今天',

                currentStatus: '显示本月',
                monthNames: ['1月','2月','3月','4月','5月','6月',
                    '7月','8月','9月','10月','11月','12月'],
                monthNamesShort: ['一','二','三','四','五','六',
                    '七','八','九','十','十一','十二'],
                monthStatus: '选择月份', yearStatus: '选择年份',
                weekHeader: '周', weekStatus: '年内周次',
                dayNames: ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'],
                dayNamesShort: ['周日','周一','周二','周三','周四','周五','周六'],
                dayNamesMin: ['日','一','二','三','四','五','六'],
                dayStatus: '设置 DD 为一周起始',

                dateStatus: '选择 m月 d日, DD',
                dateFormat: 'yy-mm-dd',   //日期格式化形式

                firstDay: 7,
                initStatus: '请选择日期',

                showMonthAfterYear: true,
                yearSuffix: '年',

                isRTL: false
            };
            $.datepicker.setDefaults($.datepicker.regional[_get_datepicker_locale("{{ LANGUAGE_CODE }}")]);
        }
);

function _get_datepicker_locale(s) {
    var l = s.split('-');
    if (l[0] == 'en') return '';
    if (l[1]) l[1] = l[1].toUpperCase();
    l = l.join('_');
    return l;
}

    $(document).ready(function(){
        /* packing list scripts */
        $('.see_pk_list').die().live('click', function(){
            var parent = $(this).parent().parent();
            var id_shipemnt = $(this).attr('for_shipment');
            var remaining_list = $('#remaining_list_for_' + id_shipemnt);
            var packing_form = $('#packing_form_' + id_shipemnt);
            if (remaining_list.is(":hidden")) {
                packing_form.slideUp(
                        'normal', function() {
                            remaining_list.slideDown();
                        }
                )
            } else {
                remaining_list.slideUp(
                        "normal", function() {
                            packing_form.slideDown();
                        }
                );
            }

            $('.packing_status', parent).change();
        });

        $(".new_packing_list .create").die().live('click', function(){
            var shipment_id = $(this).attr('for_shipment');
            var shipping_fee = $("input[name=manual_shipping_fee_for_" + shipment_id + "]");
            if (shipping_fee && shipping_fee.val() == "") {
                alert("Please input shipping fee");
                return;
            }

            var handling_fee = $("input[name=manual_handling_fee_for_" + shipment_id + "]");
            if (handling_fee && handling_fee.val() == "") {
                alert("Please input handling fee");
                return;
            }

            var data = $("#remaining_list_for_" + shipment_id).serialize();
            $.ajax({
                type: 'POST',
                url: "/orders/new/packing",
                data: data,
                success: function(data, status) {
                    if (data.res == 'SUCCESS') {
                        // reload updated shipment
                        shipment_reload(shipment_id);

                        // load new created shipment
                        $("<div id='shipment_" + data.id_new_shipment + "'>").addClass("shipment").appendTo($('.packing'));
                        shipment_reload(data.id_new_shipment);
                    } else {
                        alert('{% trans "Error:" %}' + data.err);
                    }

                }
            });
        });

        $(".packing_status").die().live('change', function(){
            var status = $(this).val();
            if (parseInt(status) == 3) {
                $('.tracking_num', $(this).parent()).slideDown();
            } else {
                $('.tracking_num', $(this).parent()).slideUp();
                var orig_value = $('input', $(this).parent()).attr('orig_value');
                orig_value = orig_value || "";
                $('input', $(this).parent()).val(orig_value);
            }
        });

        $(".update_shipment").die().live('click', function(){
            var shipment_id = $(this).attr('for_shipment');
            var form = $("#packing_form_" + shipment_id);

            var shipping_fee = $("input[name=manual_shipping_fee_for_" + shipment_id + "]", form);
            if (shipping_fee && shipping_fee.val() == "") {
                alert("Please input shipping fee");
                return;
            }

            var handling_fee = $("input[name=manual_handling_fee_for_" + shipment_id + "]", form);
            if (handling_fee && handling_fee.val() == "") {
                alert("Please input handling fee");
                return;
            }

            $(".packing_item_out_count", form).each(function(){
                if ($(this).val() == "") {
                    alert("Please input all items updated count");
                    return;
                } else {
                    if (parseInt($(this).val()) > parseInt($(this).attr('orig_quantity'))) {
                        alert("Please input valid item update count");
                        return;
                    }
                }
            })

            var data = form.serialize();
            var status = $("#packing_status_for_" + shipment_id).val()
            data += "&packing_status_for_" + shipment_id + "=" + status;

            $.ajax({
                type: 'POST',
                url: "/orders/update/packing",
                data: data,
                success: function(data, status) {
                    if (data.res == 'SUCCESS') {
                        // reload updated shipment
                        $("#shipment_" + shipment_id).slideUp('normal', function(){
                            shipment_reload(shipment_id);
                        });
                    } else {
                        alert('{% trans "Error:" %}' + data.err);
                    }
                }
            });
        });

        $(".delete_shipment").die().live('click', function() {
            var shipment_id = $(this).attr('for_shipment');
            var data = $("#packing_form_" + shipment_id).serialize();

            $.ajax({
                type: 'POST',
                url: "/orders/delete/packing",
                data: data,
                success: function(data, status) {
                    if (data.res == 'SUCCESS') {
                        var shipment = $("#shipment_" + data.id_shipment);
                        shipment.slideUp('normal', function(){
                            $(this).remove();
                        })
                    } else {
                        alert('{% trans "Error:" %}' + data.err);
                    }
                }
            });
        });

        $(".cancel_shipment").die().live('click', function() {
            var shipment_id = $(this).attr('for_shipment');
            $('#see_pk_list_for_' + shipment_id).click();
        });

        $(".delete_shipping_item").die().live('click', function() {
            var id_shipping_item = $(this).attr('for_packing_item');
            var id_shipment = $(this).attr('for_shipment');
            var out_count = $('#pack_item_out_count_for_' + id_shipping_item);
            out_count.val(0);

            var update_btn = $('.update_shipment', $("#packing_form_" + id_shipment));
            update_btn.click();
        })

        function shipment_reload(id_shipment) {
            var shipment = $("#shipment_" + id_shipment);
            var href = "{% url 'order_packing_list' %}"
            href += "{{ packing.order_id }}";
            href += "?shipment=" + id_shipment;
            shipment.load(href, function(data){
                if (data.trim()) {
                    shipment.html(data);
                    shipment.slideDown();
                    var packing_form = $('#packing_from_' + id_shipment);
                    if (packing_form) {
                        $("#see_pk_list_for_" + id_shipment).click();
                    }
                } else {
                    shipment.slideUp('normal', function(){
                        shipment.html(data)
                    });
                }
            });
        }


    });
</script>
